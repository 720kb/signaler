/*
 * siglr
 *
 * 
 * https://github.com/720kb/signaler
 * Dario Andrei <wouldgo84@gmail.com>
 * 
 * MIT license
 * 2015-09-20T14:32:32.709Z
 */
!function(e){"use strict";var n=function(n,a,t){var i,o,r={audio:!0,video:!0},s={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},c={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:23.21.150.121"}]},l={},d={},h={},m={},u={},f={},w={},v="unknown-peer",g=function(n){e.console.error(n)},p=function(n){e.console.error(n)},b=function(n,a,t){e.console.error(n,a,t)},y=function(n){e.console.error(n)},C=function(n){e.console.error(n)},E=function(n){e.console.error(n)},S=function(n){e.console.error(n)},k=function(n,a,t){e.console.info("iceCandidate for",t,"in",a,"successfully added")},A=function(n,a,t){if(n&&a&&t&&t.data){if(("string"==typeof t.data||t.data instanceof String)&&t.data.indexOf("_signaler")>=0)switch(t.data){case"_signaler:got-stream?":o&&u[n]&&u[n][a]&&u[n][a].addStream(o);break;default:e.console.error("Not interesting event atm")}else{var i={payload:t.data,whoami:a,channel:n},r=new e.CustomEvent("signaler:data-arrived",{detail:i});e.dispatchEvent(r)}e.console.debug(t.data)}else e.console.error("Missing mandatory fields <channel>, <who> or data channel event not valid")},M=function(n,a){var t={whoami:a,channel:n},i=new e.CustomEvent("signaler:datachannel-opened",{detail:t});f[n][a]=this,w[n]&&w[n].indexOf(a)>=0&&this.send("_signaler:got-stream?"),e.dispatchEvent(i),e.console.info("Data channel",this,"opened...")},T=function(n,a){var t={whoami:a,channel:n},i=new e.CustomEvent("signaler:datachannel-closed",{detail:t});delete f[n][a],0===Object.keys(f[n])&&delete f[n],e.dispatchEvent(i),e.console.info("Data channel",this,"closed.")},$=function(n,a,t){if(n&&a&&t&&t.channel){var i=b.bind(t.channel,n,a),o=A.bind(t.channel,n,a),r=M.bind(t.channel,n,a),s=T.bind(t.channel,n,a);t.channel.onerror=i,t.channel.onmessage=o,t.channel.onopen=r,t.channel.onclose=s}else e.console.error("Missing mandatory fields <channel>, <who> or event not present")},L=function(n,a,t,i,o){if(e.console.debug("Set local description",o),!o||"offer"!==o&&"answer"!==o)e.console.error("Type not recognized:",o);else{var r={type:o,channel:t};r[o]=i,n.sendTo(a,r,!0)}},O=function(n,a,t,i){var o=L.bind(this,n,t,a,i,"answer");this.setLocalDescription(new e.RTCSessionDescription(i),o,p)},D=function(n,a,t,i){if(e.console.debug("Set remote description",i),i&&"slave"===i){var o=O.bind(this,n,a,t);this.createAnswer(o,C,s)}else i&&"master"===i&&e.console.info("handshake finished")},I=function(n,a,t,i){var o=L.bind(this,n,t,a,i,"offer");this.setLocalDescription(new e.RTCSessionDescription(i),o,p)},R=function(n,a,t,i){var o=D.bind(this,n,a,t,"master");this.setRemoteDescription(new e.RTCSessionDescription(i),o,y)},N=function(n,a,t,i){var o=D.bind(this,n,a,t,"slave");this.setRemoteDescription(new e.RTCSessionDescription(i),o,y)},P=function(n,a,t,i){if(a){if(i.candidate)m[a]||(m[a]={}),m[a][t]||(m[a][t]=[]),m[a][t].push(i.candidate),e.console.trace("generating a candidate");else if(m[a]&&m[a][t]&&Array.isArray(m[a][t])){var o=m[a][t];n.sendTo(t,{type:"use-ice-candidates",channel:a,candidates:o.splice(0,o.length)},!0),e.console.trace("From",n.whoAmI(),"to",t,"-> use candidates",o.length)}}else e.console.error("channel invalid or event.candidate null")},j=function(n,a,t,i){if(i&&i.target&&i.target.signalingState)switch(i.target.signalingState){default:e.console.info("signaling state not interesting atm",i.target.signalingState)}else e.console.error("signaling state changed without event value")},_=function(n,a,t,i){if(i&&i.target&&i.target.iceConnectionState)switch(i.target.iceConnectionState){case"connected":case"completed":var o=new e.CustomEvent("signaler:ready",{detail:{channel:a,whoami:t}});e.dispatchEvent(o);break;default:e.console.info("ice state not interesting atm.",i.target.iceConnectionState)}else e.console.error("ice connection state changed without event value")},x=function(n,a){if(a.stream)for(var t,i,o=Object.keys(u[n]),r=0,s=o.length;s>r;r+=1)t=o[r],u[n][t]===this&&(i=new e.CustomEvent("signaler:stream",{detail:{userid:t,stream:a.stream}}),e.dispatchEvent(i));else e.console.error("No stream arrived")},U=function(n,a){if(a.stream)for(var t,i,o=Object.keys(u[n]),r=0,s=o.length;s>r;r+=1)t=o[r],u[n][t]===this&&(i=new e.CustomEvent("signaler:end",{detail:{userid:t}}),e.dispatchEvent(i));else e.console.error("No stream arrived")},q=function(n,a,t){if(h[a]===n.whoAmI()||o||w[a]&&w[a].indexOf(t)>=0){var i=I.bind(this,n,a,t);this.createOffer(i,g)}else e.console.info("You can not negotiate a p2p connection")},Y=function(n,a){var t;o||(t=new e.CustomEvent("signaler:my-stream",{detail:{userid:n.whoAmI(),stream:a}}),o=a,e.dispatchEvent(t))},z=function(n,a,t,i){var o,r,s,h,m,w,v,g,p,y,C,E,S;u[a]||(u[a]={}),f[a]||(f[a]={}),i?(o=new e.RTCPeerConnection(c,l),p=o.createDataChannel("signaler-datachannel",d),y=b.bind(p,a,t),C=A.bind(p,a,t),E=M.bind(p,a,t),S=T.bind(p,a,t),r=P.bind(o,n,a,t),s=x.bind(o,a),h=U.bind(o,a),m=q.bind(o,n,a,t),w=_.bind(o,n,a,t),v=$.bind(o,a,t),g=j.bind(o,n,a,t),p.onerror=y,p.onmessage=C,p.onopen=E,p.onclose=S,o.onicecandidate=r,o.onaddstream=s,o.onremovestream=h,o.onnegotiationneeded=m,o.oniceconnectionstatechange=w,o.ondatachannel=v,o.onsignalingstatechange=g):(o=new e.RTCPeerConnection(c,l),r=P.bind(o,n,a,t),s=x.bind(o,a),h=U.bind(o,a),m=q.bind(o,n,a,t),w=_.bind(o,n,a,t),v=$.bind(o,a,t),g=j.bind(o,n,a,t),o.onicecandidate=r,o.onaddstream=s,o.onremovestream=h,o.onnegotiationneeded=m,o.oniceconnectionstatechange=w,o.ondatachannel=v,o.onsignalingstatechange=g),u[a][t]=o},F=function(n,a){a?n.sendTo(v,{type:"create-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},V=function(n,a){a?n.sendTo(v,{type:"join-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},B=function(n){if(n){var a=Y.bind(this,n);e.getUserMedia(r,a,S)}else e.console.error("theComunicator is not provided")},G=function(n,a,t){if(a&&o)if(h[a]===n.whoAmI())if(t)u[a][t].addStream(o);else for(var i,r=Object.keys(u[a]),s=0,c=r.length;c>s;s+=1)i=r[s],i&&u[a][i].addStream(o);else u[a][h[a]].addStream(o);else e.console.error(o?"Missing mandatory field <channel>":"You must call Signaler.getUserMedia() before streamOnChannel.")},H=function(n,a,t){n&&a&&f&&f[n]&&f[n][a]?f[n][a].send(t):e.console.error("Missing mandatory fields <channel>, <who> or there is no data-channel for user",a,"in channel",n)},J=function(e,n){if(e&&f&&f[e])for(var a,t,i=Object.keys(f[e]),o=i.length,r=0;o>r;r+=1)a=i[r],a&&(t=f[e][a],t&&t.send(n))},K=function(n,a,t){a&&t&&h[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"approve",channel:a},!0)):e.console.warn("cause","Please review your code")},Q=function(n,a,t){a&&t&&h[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"un-approve",channel:a},!0)):e.console.warn("cause","Please review your code")},W=function(n,a){if(a&&a.detail&&a.detail.what&&a.detail.what.type){var t,i,r,s=a.detail,c=a.detail.what.type;switch(c){case"do-handshake":s.whoami&&s.what.channel?(h[s.what.channel]=s.who,z(n,s.what.channel,s.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"take-offer":s.whoami&&s.what.channel&&s.what.offer?(u[s.what.channel]&&u[s.what.channel][s.whoami]||(z(n,s.what.channel,s.whoami),h[s.what.channel]=s.whoami),N.call(u[s.what.channel][s.whoami],n,s.what.channel,s.whoami,s.what.offer)):e.console.error("Missing mandatory fields: <eventArrived.whoami>, <eventArrived.what.channel> and <eventArrived.what.offer>");break;case"take-answer":R.call(u[s.what.channel][s.whoami],n,s.what.channel,s.whoami,s.what.answer);break;case"take-candidates":if(s.what.candidates)for(t=0,i=k.bind(u[s.what.channel][s.whoami],n,s.what.channel,s.whoami);t<s.what.candidates.length;t+=1)u[s.what.channel][s.whoami].addIceCandidate(new e.RTCIceCandidate(s.what.candidates[t]),i,E);break;case"initiator-quit":X(n,s.what.channel,!0);break;case"slave-quit":u[s.what.channel]&&u[s.what.channel][s.whoami]&&(u[s.what.channel][s.whoami].close(),delete u[s.what.channel][s.whoami]),f[s.what.channel]&&f[s.what.channel][s.whoami]&&f[s.what.channel][s.whoami].close();break;case"approved":s.whoami&&s.what.channel?(w[s.what.channel]||(w[s.what.channel]=[]),w[s.what.channel].push(s.whoami),z(n,s.what.channel,s.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"un-approved":s.whoami&&s.what.channel?(r=w[s.what.channel].indexOf(s.whoami),r>=0&&(w[s.what.channel].splice(r,1),u[s.what.channel][s.whoami].close(),f[s.what.channel][s.whoami].close(),delete u[s.what.channel][s.whoami],delete f[s.what.channel][s.whoami])):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"you-are-un-approved":s.what.channel&&s.what.users?s.what.users.forEach(function(e){u[s.what.channel]&&u[s.what.channel][e]&&(u[s.what.channel][e].removeStream(o),u[s.what.channel][e].close(),f[s.what.channel][e].close(),delete u[s.what.channel][e],delete f[s.what.channel][e])}):e.console.error("Missing mandatory field: <eventArrived.what.channel> and <eventArrived.what.users>");break;default:e.console.error("Event valid but un-manageable. Target:",a.detail)}}else e.console.error("Event arrived is somehow invalid. Target:",a)},X=function(n,a,t){if(a)if(u[a]){for(var i,r=u[a],s=Object.keys(r),c=s.length,l=0;c>l;l+=1)i=s[l],u[a]&&u[a][i]&&u[a][i].close(),f[a]&&f[a][i]&&f[a][i].close();!t&&o&&(o.stop(),o=void 0),delete h[a],delete u[a],delete w[a],n.sendTo(v,{type:"leave-channel",channel:a},!0),e.removeEventListener("comunicator:to-me",W,!1)}else e.console.info("No peers in specified channel",a);else e.console.error("Missing mandatory parameter <channel>")},Z=function(n,a){var t=F.bind(this,a),i=V.bind(this,a),r=B.bind(this,a),s=G.bind(this,a),c=H.bind(this),l=J.bind(this),d=K.bind(this,a),h=Q.bind(this,a),m=X.bind(this,a),u=W.bind(this,a),f={userIsPresent:a.userIsPresent,createChannel:t,joinChannel:i,getUserMedia:r,streamOnChannel:s,sendTo:c,broadcast:l,approve:d,unApprove:h,leaveChannel:m};Object.defineProperties(f,{myStream:{get:function(){return o}}}),e.addEventListener("comunicator:to-me",u,!1),n(f)},ee=function(e){i.then(Z.bind(this,e))};return n&&e.Comunicator?n instanceof e.Promise?i=n:("string"==typeof n||n instanceof String)&&(i=new e.Comunicator(n)):e.console.error("Missing mandatory <url> parameter or Comunicator (http://github.com/720kb/comunicator) not present."),a&&(r=a),t&&(s=t),e._getPeers=function(){return u},e._getDataChannels=function(){return f},e._getIceCandidates=function(){return m},e._getInititators=function(){return h},e._getApprovedUsers=function(){return w},new e.Promise(ee.bind(this))};e.Signaler=n}(window),function(e,n){"use strict";e.module("720kb.signaler",[]).provider("Signaler",function(){var e,a=function(a,t,i){e=new n(a,t,i)};return{initSignaler:a,$get:["$rootScope","$window","$log",function(n,a,t){var i=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:data-arrived"),n.$emit("signaler:data-arrived",e.detail)}):t.error("Missing mandatory event")},o=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:datachannel-opened"),n.$emit("signaler:datachannel-opened",e.detail)}):t.error("Missing mandatory event")},r=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:datachannel-closed"),n.$emit("signaler:datachannel-closed",e.detail)}):t.error("Missing mandatory event")},s=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:ready"),n.$emit("signaler:ready",e.detail)}):t.error("Missing mandatory event")},c=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:stream",e.detail)}):t.error("Missing mandatory event")},l=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:end",e.detail)}):t.error("Missing mandatory event")},d=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:my-stream",e.detail)}):t.error("Missing mandatory event")};return a.addEventListener("signaler:data-arrived",i,!1),a.addEventListener("signaler:datachannel-opened",o,!1),a.addEventListener("signaler:datachannel-closed",r,!1),a.addEventListener("signaler:ready",s,!1),a.addEventListener("signaler:stream",c,!1),a.addEventListener("signaler:end",l,!1),a.addEventListener("signaler:my-stream",d,!1),n.$on("$destroy",function(){a.removeEventListener("signaler:data-arrived",i,!1),a.removeEventListener("signaler:datachannel-opened",o,!1),a.removeEventListener("signaler:datachannel-closed",r,!1),a.removeEventListener("signaler:ready",s,!1),a.removeEventListener("signaler:stream",c,!1),a.removeEventListener("signaler:end",l,!1),a.removeEventListener("signaler:my-stream",d,!1)}),e}]}})}(angular,Signaler);
//# sourceMappingURL=signaler-angular.min.js.map