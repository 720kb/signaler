/*
 * siglr - v1.1.3
 *
 * 
 * https://github.com/wouldgo/signaler
 * MIT license
 * 2015-06-18T19:48:56.231Z
 */


!function(e){"use strict";var n=function(n,a,t,o,i,s,c){var r,d,l,h,u="unknown-peer",m={},w={},f={},v={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},p={iceServers:[{url:"stun:stun.l.google.com:19302"}]},g={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]},b={},y={audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"}},video:!0},C=function(n){e.console.warn("cause",n)},E=function(n){if(n&&n.data){e.console.info(n.data);var a=new e.CustomEvent("stream:data-arrived",{detail:n.data});e.dispatchEvent(a)}else e.console.warn("cause","Data channel event not valid")},S=function(){e.console.info("Data channel",this,"opened...")},k=function(){e.console.info("Data channel",this,"closed.")},T=function(n){n&&n.channel?(n.channel.onerror=C,n.channel.onmessage=E,n.channel.onopen=S,n.channel.onclose=k):e.console.warn("cause","Event or event channel not present")},$=function(n){e.console.warn("cause",n)},D=function(n){e.console.warn("cause",n)},R=function(n){e.console.warn("cause",n)},O=function(n){e.console.warn("cause",n)},j=function(n){e.console.warn("cause",n)},L=function(){e.console.debug("IceCandidate successfully added.")},I=function(n){e.console.warn("cause",n)},P=function(n,a){if(a.stream)for(var t,o,i,s=Object.keys(w[n]),c=0,r=s.length;r>c;c+=1)t=s[c],w[n][t]===this&&(o={userid:t,mediaElement:a.stream},i=new e.CustomEvent("stream:arrive",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},A=function(n,a){if(a.stream)for(var t,o,i,s=Object.keys(w[n]),c=0,r=s.length;r>c;c+=1)t=s[c],w[n][t]===this&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},N=function(n,a){if(a.target&&e.console.debug("Ice state:",a.target.iceConnectionState),a.target&&"disconnected"===a.target.iceConnectionState)for(var t,o,i,s=w[n],c=Object.keys(s),r=c.length,d=0;r>d;d+=1)t=c[d],a.target===w[n][t]&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i),delete w[n][t])},M=function(e,n,a){e.sendTo(n,{type:"use-ice-candidates",channel:a})},U=function(n,a,t,o){var i=M.bind(this,n,t,o);this.setRemoteDescription(new e.RTCSessionDescription(a),i,j)},K=function(n,a,t,o){o.candidate&&a?n.sendTo(t,{type:"ice-candidate",channel:a,candidate:o.candidate}):e.console.debug("Event arrived, channel or user invalid")},F=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"answer",channel:a,answer:o}),n.sendTo(t,{type:"use-ice-candidates",channel:a})},O)},G=function(e,n,a){var t=F.bind(this,e,n,a);this.createAnswer(t,R,v)},H=function(n,a,t,o){var i=G.bind(this,n,a,t);this.setRemoteDescription(new e.RTCSessionDescription(o),i,j)},V=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"open",channel:a,offer:o})},O)},q=function(e,n,a){var t=V.bind(this,e,n,a);l&&!this.singleton&&(this.singleton=!0,this.createOffer(t,D))},x=function(n,a,t,o){var i,s;l||(l=o,i=new e.CustomEvent("stream:my-stream",{detail:o}),e.dispatchEvent(i)),t!==u&&w[a][t]?(s=q.bind(w[a][t],n,a,t),w[a][t].onnegotiationneeded=s,w[a][t].addStream(l)):r.addStream(l)},z=function(n,a,t){var o,i=new e.RTCPeerConnection(p,g);i.onicecandidate=K.bind(i,n,a,t),i.onaddstream=P.bind(i,a),i.onremovestream=A.bind(i,a),i.onnegotiationneeded=q.bind(i,n,a,t),i.oniceconnectionstatechange=N.bind(i,a),i.ondatachannel=T,o=i.createDataChannel("signaler-datachannel",b),o.onerror=C,o.onmessage=E,o.onopen=S,o.onclose=k,w[a]||(w[a]={}),f[a]||(f[a]={}),t===u?(r=i,d=o):(w[a][t]=i,f[a][t]=o)},B=function(n,a){if(a&&a.detail&&a.detail.what.type){var t,o,i,s,c,h,u,v,p,g,b,y,C=a.detail,E=0;switch(C.what.type){case"offer":C.what.offer?(m[C.what.channel]||(m[C.what.channel]=C.whoami),r&&(w[C.what.channel][C.whoami]=r,f[C.what.channel][C.whoami]=d,w[C.what.channel][C.whoami].onicecandidate=K.bind(w[C.what.channel][C.whoami],n,C.what.channel,C.whoami),r=void 0,d=void 0),H.call(w[C.what.channel][C.whoami],n,C.what.channel,C.whoami,C.what.offer)):e.console.error("No payload");break;case"answer":C.what.answer&&C.whoami?(r&&(w[C.what.channel][C.whoami]=r,f[C.what.channel][C.whoami]=d,w[C.what.channel][C.whoami].onicecandidate=K.bind(w[C.what.channel][C.whoami],n,C.what.channel,C.whoami),r=void 0,d=void 0),U.call(w[C.what.channel][C.whoami],n,C.what.answer,C.whoami,C.what.channel)):e.console.warn("No payload or user identification");break;case"candidate":if(C.what.candidate&&C.what.candidate.length>0)for(t=C.what.candidate.length,E=0;t>E;E+=1)o=C.what.candidate[E],w[C.what.channel][C.whoami].addIceCandidate(new e.RTCIceCandidate(o),L,I);break;case"p2p-is-instantiated":w[C.what.channel][C.whoami]||(r=void 0,d=void 0,z(n,C.what.channel,C.whoami)),n.sendTo(C.whoami,{type:"join-channel",channel:C.what.channel});break;case"instantiate-p2p":l?(z(n,C.what.channel,C.whoami),x(n,C.what.channel,C.whoami,l)):e.console.error("User stream [myStream] is not defined...");break;case"redo-join":n.sendTo(C.whoami,{type:"join-channel",channel:C.what.channel});break;case"approved":for(i=C.what.listeners,s=i.length,c=0;s>c;c+=1)h=i[c],h&&(w[C.what.channel][h]?(w[C.what.channel][h].singleton=!1,w[C.what.channel][h].addStream(l)):(z(n,C.what.channel,h),x(n,C.what.channel,h,l)));break;case"un-approved":for(u=w[C.what.channel],v=Object.keys(u),p=v.length,g=m[C.what.channel],b=0;p>b;b+=1)y=v[b],y!==String(g)&&(w[C.what.channel][y].singleton=!1,w[C.what.channel][y].removeStream(l));break;default:e.console.warn("cause","Event valid but un-manageable","target",a.detail)}}else e.console.warn("cause","Event arrived is somehow invalid","target",a)},J=function(n,a){if(a&&h&&h.whoReallyAmI){var t=x.bind(this,n,a,u);m[a]=h.whoReallyAmI,z(n,a,u),e.getUserMedia(y,t,$)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},Q=function(n,a){a?(z(n,a,u),n.sendTo(u,{type:"join-channel",channel:a})):e.console.warn("cause","Please provide channel name")},W=function(n,a){if(a){var t=x.bind(this,n,a,m[a]);e.getUserMedia(y,t,$)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},X=function(n,a,t){a&&h.whoReallyAmI&&t&&m[a]===h.whoReallyAmI?n.sendTo(t,{type:"approve",channel:a}):e.console.warn("cause","Please review your code")},Y=function(n,a,t){a&&t?n.sendTo(t,{type:"un-approve",channel:a}):e.console.warn("cause","Please review your code")},Z=function(n,a){if(a){r&&r.close(),d&&d.close();for(var t,o=w[a],i=Object.keys(o),s=i.length,c=0;s>c;c+=1)t=i[c],w[a][t]&&(w[a][t].close(),f[a][t].close());r=void 0,d=void 0,l&&l.stop(),l=void 0,delete m[a],delete w[a],n.broadcast({type:"leave-channel",channel:a}),e.removeEventListener("comunicator:to-me",B,!1)}else e.console.warn("cause","Please provide channel name")},_=function(){for(var e,n,a,t,o,i,s,c=Object.keys(f),r=0,d=c.length,l={};d>r;r+=1)if(n=c[r],n&&(l[n]||(l[n]={}),e=f[n]))for(a=Object.keys(e),t=0,o=a.length;o>t;t+=1)i=a[t],i&&(s=e[i],s&&"open"===s.readyState&&(l[n][i]=s));return l},ee=function(n,a){e.addEventListener("comunicator:to-me",B.bind(this,a),!1),n({userIsPresent:a.userIsPresent,createChannel:J.bind(this,a),joinChannel:Q.bind(this,a),streamOnChannel:W.bind(this,a),approve:X.bind(this,a),unApprove:Y.bind(this,a),leaveChannel:Z.bind(this,a),dataChannels:_.bind(this)})},ne=function(e){h.promise(n).then(ee.bind(this,e))};return a&&n&&e.Comunicator?h=new e.Comunicator(a,!0):e.console.warn("cause","Missing mandatory <url> parameters or comunicator not present."),t&&(y=t),o&&(v=o),i&&(p=i),s&&(g=s),c&&(b=c),new Promise(ne.bind(this))};e.Signaler=n}(window),function(e,n){"use strict";e.module("720kb.signaler",[]).provider("Signaler",function(){var e,a="signaler:ready",t=function(t,o,i,s,c,r){e=new n([a],t,o,i,s,c,r)};return{initSignaler:t,$get:["$rootScope","$window","$log",function(n,t,o){var i,s=["$stateChangeSuccess","$routeChangeSuccess"],c=[],r=s.length,d=0,l=function(e){n.$apply(function(n){n.$emit("stream:my-stream",e.detail)}),o.debug("stream:my-stream dispatched")},h=function(e){n.$apply(function(n){n.$emit("stream:data-arrived",e.detail)}),o.debug("stream:data-arrived dispatched")},u=function(e){n.$apply(function(n){n.$emit("stream:arrive",e.detail)}),o.debug("stream:arrive dispatched")},m=function(e){n.$apply(function(n){n.$emit("stream:end",e.detail)}),o.debug("stream:end dispatched")},w=function(){for(var e=0,n=c.length,i=new t.Event(a);n>e;e+=1)c[e]();t.dispatchEvent(i),o.debug("KickOff DOM Event triggered")};for(t.addEventListener("stream:my-stream",l,!1),t.addEventListener("stream:data-arrived",h,!1),t.addEventListener("stream:arrive",u,!1),t.addEventListener("stream:end",m,!1),n.$on("$destroy",function(){t.removeEventListener("stream:my-stream",l,!1),t.removeEventListener("stream:data-arrived",h,!1),t.removeEventListener("stream:arrive",u,!1),t.removeEventListener("stream:end",m,!1)});r>d;d+=1)i=s[d],c.push(n.$on(i,w));return e}]}})}(angular,Signaler);
//# sourceMappingURL=signaler-angular.min.js.map