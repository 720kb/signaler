/*
 * siglr - v2.2.3
 *
 * 
 * https://github.com/720kb/signaler
 * MIT license
 * 2015-07-13T21:11:26.264Z
 */


!function(e,n){"use strict";var a=function(a,t,o,i,s,c){var r,d,l,h,u="unknown-peer",m={},w={},v={},f={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},p={iceServers:[{url:"stun:stun.l.google.com:19302"}]},g={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]},b={},y={audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"}},video:!0},E=function(n){e.console.warn("cause",n)},C=function(n){if(n&&n.data){e.console.info(n.data);var a=new e.CustomEvent("stream:data-arrived",{detail:n.data});e.dispatchEvent(a)}else e.console.warn("cause","Data channel event not valid")},S=function(){var n=new e.CustomEvent("stream:datachannel-opened");e.dispatchEvent(n),e.console.info("Data channel",this,"opened...")},T=function(){e.console.info("Data channel",this,"closed.")},k=function(n){n&&n.channel?(n.channel.onerror=E,n.channel.onmessage=C,n.channel.onopen=S,n.channel.onclose=T):e.console.warn("cause","Event or event channel not present")},$=function(n){e.console.warn("cause",n)},D=function(n){e.console.warn("cause",n)},L=function(n){e.console.warn("cause",n)},j=function(n){e.console.warn("cause",n)},O=function(n){e.console.warn("cause",n)},P=function(){e.console.debug("IceCandidate successfully added.")},R=function(n){e.console.warn("cause",n)},I=function(n,a){if(a.stream)for(var t,o,i,s=Object.keys(w[n]),c=0,r=s.length;r>c;c+=1)t=s[c],w[n][t]===this&&(o={userid:t,mediaElement:a.stream},i=new e.CustomEvent("stream:arrive",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},A=function(n,a){if(a.stream)for(var t,o,i,s=Object.keys(w[n]),c=0,r=s.length;r>c;c+=1)t=s[c],w[n][t]===this&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},N=function(n,a){if(a.target&&e.console.debug("Ice state:",a.target.iceConnectionState),a.target&&"disconnected"===a.target.iceConnectionState)for(var t,o,i,s=w[n],c=Object.keys(s),r=c.length,d=0;r>d;d+=1)t=c[d],a.target===w[n][t]&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i),delete w[n][t])},M=function(e,n,a){e.sendTo(n,{type:"use-ice-candidates",channel:a},!0)},U=function(n,a,t,o){var i=M.bind(this,n,t,o);this.setRemoteDescription(new e.RTCSessionDescription(a),i,O)},F=function(n,a,t,o){o.candidate&&a?n.sendTo(t,{type:"ice-candidate",channel:a,candidate:o.candidate},!0):e.console.debug("Event arrived, channel or user invalid")},G=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"answer",channel:a,answer:o},!0),n.sendTo(t,{type:"use-ice-candidates",channel:a},!0)},j)},H=function(e,n,a){var t=G.bind(this,e,n,a);this.createAnswer(t,L,f)},K=function(n,a,t,o){var i=H.bind(this,n,a,t);this.setRemoteDescription(new e.RTCSessionDescription(o),i,O)},V=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"open",channel:a,offer:o},!0)},j)},q=function(e,n,a){var t=V.bind(this,e,n,a);l&&!this.singleton&&(this.singleton=!0,this.createOffer(t,D))},x=function(n,a,t,o){var i,s;l||(l=o,i=new e.CustomEvent("stream:my-stream",{detail:o}),e.dispatchEvent(i)),w[a][t]?(s=q.bind(w[a][t],n,a,t),w[a][t].onnegotiationneeded=s,w[a][t].addStream(l)):r.addStream(l)},z=function(n,a,t){var o,i=new e.RTCPeerConnection(p,g);i.onicecandidate=F.bind(i,n,a,t),i.onaddstream=I.bind(i,a),i.onremovestream=A.bind(i,a),i.onnegotiationneeded=q.bind(i,n,a,t),i.oniceconnectionstatechange=N.bind(i,a),i.ondatachannel=k,o=i.createDataChannel("signaler-datachannel",b),o.onerror=E,o.onmessage=C,o.onopen=S,o.onclose=T,w[a]||(w[a]={}),v[a]||(v[a]={}),t===u?(r=i,d=o):(w[a][t]=i,v[a][t]=o)},B=function(n,a){if(a&&a.detail&&a.detail.what.type){var t,o,i,s,c,h,u,f,p,g,b,y,E=a.detail,C=0;switch(E.what.type){case"offer":E.what.offer?(m[E.what.channel]||(m[E.what.channel]=E.whoami),r&&(w[E.what.channel][E.whoami]=r,v[E.what.channel][E.whoami]=d,w[E.what.channel][E.whoami].onicecandidate=F.bind(w[E.what.channel][E.whoami],n,E.what.channel,E.whoami),r=void 0,d=void 0),K.call(w[E.what.channel][E.whoami],n,E.what.channel,E.whoami,E.what.offer)):e.console.error("No payload");break;case"answer":E.what.answer&&E.whoami?(r&&(w[E.what.channel][E.whoami]=r,v[E.what.channel][E.whoami]=d,w[E.what.channel][E.whoami].onicecandidate=F.bind(w[E.what.channel][E.whoami],n,E.what.channel,E.whoami),r=void 0,d=void 0),U.call(w[E.what.channel][E.whoami],n,E.what.answer,E.whoami,E.what.channel)):e.console.warn("No payload or user identification");break;case"candidate":if(E.what.candidate&&E.what.candidate.length>0)for(t=E.what.candidate.length,C=0;t>C;C+=1)o=E.what.candidate[C],w[E.what.channel][E.whoami].addIceCandidate(new e.RTCIceCandidate(o),P,R);break;case"p2p-is-instantiated":w[E.what.channel][E.whoami]||(r=void 0,d=void 0,z(n,E.what.channel,E.whoami)),n.sendTo(E.whoami,{type:"join-channel",channel:E.what.channel},!0);break;case"instantiate-p2p":l?(z(n,E.what.channel,E.whoami),x(n,E.what.channel,E.whoami,l)):e.console.error("User stream [myStream] is not defined...");break;case"redo-join":n.sendTo(E.whoami,{type:"join-channel",channel:E.what.channel},!0);break;case"approved":for(i=E.what.listeners,s=i.length,c=0;s>c;c+=1)h=i[c],h&&(w[E.what.channel][h]?(w[E.what.channel][h].singleton=!1,w[E.what.channel][h].addStream(l)):(z(n,E.what.channel,h),x(n,E.what.channel,h,l)));break;case"un-approved":for(u=w[E.what.channel],f=Object.keys(u),p=f.length,g=m[E.what.channel],b=0;p>b;b+=1)y=f[b],y!==String(g)&&(w[E.what.channel][y].singleton=!1,w[E.what.channel][y].removeStream(l));break;default:e.console.warn("cause","Event valid but un-manageable","target",a.detail)}}else e.console.warn("cause","Event arrived is somehow invalid","target",a)},J=function(n,a){if(a){var t=x.bind(this,n,a,u);m[a]=n.whoAmI(),z(n,a,u),l?t(l):e.getUserMedia(y,t,$)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},Q=function(n,a){a?(z(n,a,u),n.sendTo(u,{type:"join-channel",channel:a},!0)):e.console.warn("cause","Please provide channel name")},W=function(n,a){if(a){var t=x.bind(this,n,a,m[a]);l?t(l):e.getUserMedia(y,t,$)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},X=function(n,a,t){a&&t&&m[a]===n.whoAmI()?n.sendTo(t,{type:"approve",channel:a},!0):e.console.warn("cause","Please review your code")},Y=function(n,a,t){a&&t?n.sendTo(t,{type:"un-approve",channel:a},!0):e.console.warn("cause","Please review your code")},Z=function(n,a,t){if(a){r&&r.close(),d&&d.close();for(var o,i=w[a],s=Object.keys(i),c=s.length,h=0;c>h;h+=1)o=s[h],w[a][o]&&(w[a][o].close(),v[a][o].close());r=void 0,d=void 0,!t&&l&&(l.stop(),l=void 0),delete m[a],delete w[a],n.broadcast({type:"leave-channel",channel:a},!0),e.removeEventListener("comunicator:to-me",B,!1)}else e.console.warn("cause","Please provide channel name")},_=function(){for(var e,n,a,t,o,i,s,c=Object.keys(v),r=0,d=c.length,l={};d>r;r+=1)if(n=c[r],n&&(l[n]||(l[n]={}),e=v[n]))for(a=Object.keys(e),t=0,o=a.length;o>t;t+=1)i=a[t],i&&(s=e[i],s&&"open"===s.readyState&&(l[n][i]=s));return l},ee=function(n,a){e.addEventListener("comunicator:to-me",B.bind(this,a),!1),n({userIsPresent:a.userIsPresent,createChannel:J.bind(this,a),joinChannel:Q.bind(this,a),streamOnChannel:W.bind(this,a),approve:X.bind(this,a),unApprove:Y.bind(this,a),leaveChannel:Z.bind(this,a),dataChannels:_.bind(this)})},ne=function(e){h.then(ee.bind(this,e))};return a&&n?a instanceof e.Promise?h=a:("string"==typeof a||a instanceof String)&&(h=new n(a)):e.console.warn("cause","Missing mandatory <url> parameters or comunicator not present."),t&&(y=t),o&&(f=o),i&&(p=i),s&&(g=s),c&&(b=c),new e.Promise(ne.bind(this))};e.Signaler=a}(window,Comunicator),function(e,n){"use strict";e.module("720kb.signaler",[]).provider("Signaler",function(){var e,a=function(a,t,o,i,s,c){e=new n(a,t,o,i,s,c)};return{initSignaler:a,$get:["$rootScope","$window","$log",function(n,a,t){var o=function(e){n.$apply(function(n){n.$emit("stream:my-stream",e.detail)}),t.debug("stream:my-stream dispatched")},i=function(){n.$apply(function(e){e.$emit("stream:datachannel-opened")}),t.debug("stream:datachannel-opened dispatched")},s=function(e){n.$apply(function(n){n.$emit("stream:data-arrived",e.detail)}),t.debug("stream:data-arrived dispatched")},c=function(e){n.$apply(function(n){n.$emit("stream:arrive",e.detail)}),t.debug("stream:arrive dispatched")},r=function(e){n.$apply(function(n){n.$emit("stream:end",e.detail)}),t.debug("stream:end dispatched")};return a.addEventListener("stream:my-stream",o,!1),a.addEventListener("stream:datachannel-opened",i,!1),a.addEventListener("stream:data-arrived",s,!1),a.addEventListener("stream:arrive",c,!1),a.addEventListener("stream:end",r,!1),n.$on("$destroy",function(){a.removeEventListener("stream:my-stream",o,!1),a.removeEventListener("stream:datachannel-opened",i,!1),a.removeEventListener("stream:data-arrived",s,!1),a.removeEventListener("stream:arrive",c,!1),a.removeEventListener("stream:end",r,!1)}),e}]}})}(angular,Signaler);
//# sourceMappingURL=signaler-angular.min.js.map