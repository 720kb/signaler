/*
 * siglr
 *
 * 
 * https://github.com/720kb/signaler
 * Dario Andrei <wouldgo84@gmail.com>
 * 
 * MIT license
 * 2015-09-28T19:26:58.819Z
 */
!function(e){"use strict";var n=function(n,a,t){var i,r,o={audio:!0,video:!0},s={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},c={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:23.21.150.121"}]},l={},d={},h={},m={},u={},f={},v={},g="unknown-peer",w=function(n){e.console.error(n)},p=function(n){e.console.error(n)},b=function(n,a,t){e.console.error(n,a,t)},y=function(n){e.console.error(n)},E=function(n){e.console.error(n)},C=function(n){e.console.error(n)},S=function(n){e.console.error(n);var a=new e.CustomEvent("signaler:usermedia-error",{detail:n});e.dispatchEvent(a)},k=function(n,a,t){e.console.info("iceCandidate for",t,"in",a,"successfully added")},A=function(n,a,t){if(n&&a&&t&&t.data){if(("string"==typeof t.data||t.data instanceof String)&&t.data.indexOf("_signaler")>=0)switch(t.data){case"_signaler:got-stream?":r&&u[n]&&u[n][a]&&u[n][a].addStream(r);break;default:e.console.error("Not interesting event atm")}else{var i={payload:t.data,whoami:a,channel:n},o=new e.CustomEvent("signaler:data-arrived",{detail:i});e.dispatchEvent(o)}e.console.debug(t.data)}else e.console.error("Missing mandatory fields <channel>, <who> or data channel event not valid")},M=function(n,a){var t={whoami:a,channel:n},i=new e.CustomEvent("signaler:datachannel-opened",{detail:t});f[n][a]=this,v[n]&&v[n].indexOf(a)>=0&&this.send("_signaler:got-stream?"),e.dispatchEvent(i),e.console.info("Data channel",this,"opened...")},$=function(n,a){var t={whoami:a,channel:n},i=new e.CustomEvent("signaler:datachannel-closed",{detail:t});delete f[n][a],0===Object.keys(f[n])&&delete f[n],e.dispatchEvent(i),e.console.info("Data channel",this,"closed.")},L=function(n,a,t){if(n&&a&&t&&t.channel){var i=b.bind(t.channel,n,a),r=A.bind(t.channel,n,a),o=M.bind(t.channel,n,a),s=$.bind(t.channel,n,a);t.channel.onerror=i,t.channel.onmessage=r,t.channel.onopen=o,t.channel.onclose=s}else e.console.error("Missing mandatory fields <channel>, <who> or event not present")},T=function(n,a,t,i,r){if(e.console.debug("Set local description",r),!r||"offer"!==r&&"answer"!==r)e.console.error("Type not recognized:",r);else{var o={type:r,channel:t};o[r]=i,n.sendTo(a,o,!0)}},O=function(n,a,t,i){var r=T.bind(this,n,t,a,i,"answer");this.setLocalDescription(new e.RTCSessionDescription(i),r,p)},D=function(n,a,t,i){if(e.console.debug("Set remote description",i),i&&"slave"===i){var r=O.bind(this,n,a,t);this.createAnswer(r,E,s)}else i&&"master"===i&&e.console.info("handshake finished")},I=function(n,a,t,i){var r=T.bind(this,n,t,a,i,"offer");this.setLocalDescription(new e.RTCSessionDescription(i),r,p)},R=function(n,a,t,i){var r=D.bind(this,n,a,t,"master");this.setRemoteDescription(new e.RTCSessionDescription(i),r,y)},N=function(n,a,t,i){var r=D.bind(this,n,a,t,"slave");this.setRemoteDescription(new e.RTCSessionDescription(i),r,y)},P=function(n,a,t,i){if(a){if(i.candidate)m[a]||(m[a]={}),m[a][t]||(m[a][t]=[]),m[a][t].push(i.candidate),e.console.trace("generating a candidate");else if(m[a]&&m[a][t]&&Array.isArray(m[a][t])){var r=m[a][t];n.sendTo(t,{type:"use-ice-candidates",channel:a,candidates:r.splice(0,r.length)},!0),e.console.trace("From",n.whoAmI(),"to",t,"-> use candidates",r.length)}}else e.console.error("channel invalid or event.candidate null")},j=function(n,a,t,i){if(i&&i.target&&i.target.signalingState)switch(i.target.signalingState){default:e.console.info("signaling state not interesting atm",i.target.signalingState)}else e.console.error("signaling state changed without event value")},_=function(n,a,t,i){if(i&&i.target&&i.target.iceConnectionState)switch(i.target.iceConnectionState){case"connected":case"completed":var r=new e.CustomEvent("signaler:ready",{detail:{channel:a,whoami:t}});e.dispatchEvent(r);break;default:e.console.info("ice state not interesting atm.",i.target.iceConnectionState)}else e.console.error("ice connection state changed without event value")},x=function(n,a){if(a.stream)for(var t,i,r=Object.keys(u[n]),o=0,s=r.length;s>o;o+=1)t=r[o],u[n][t]===this&&(i=new e.CustomEvent("signaler:stream",{detail:{userid:t,stream:a.stream}}),e.dispatchEvent(i));else e.console.error("No stream arrived")},U=function(n,a){if(a.stream)for(var t,i,r=Object.keys(u[n]),o=0,s=r.length;s>o;o+=1)t=r[o],u[n][t]===this&&(i=new e.CustomEvent("signaler:end",{detail:{userid:t}}),e.dispatchEvent(i));else e.console.error("No stream arrived")},q=function(n,a,t){if(h[a]===n.whoAmI()||r||v[a]&&v[a].indexOf(t)>=0){var i=I.bind(this,n,a,t);this.createOffer(i,w)}else e.console.info("You can not negotiate a p2p connection")},Y=function(n,a){var t;r||(t=new e.CustomEvent("signaler:my-stream",{detail:{userid:n.whoAmI(),stream:a}}),r=a,e.dispatchEvent(t))},z=function(n,a,t,i){var r,o,s,h,m,v,g,w,p,y,E,C,S;u[a]||(u[a]={}),f[a]||(f[a]={}),i?(r=new e.RTCPeerConnection(c,l),p=r.createDataChannel("signaler-datachannel",d),y=b.bind(p,a,t),E=A.bind(p,a,t),C=M.bind(p,a,t),S=$.bind(p,a,t),o=P.bind(r,n,a,t),s=x.bind(r,a),h=U.bind(r,a),m=q.bind(r,n,a,t),v=_.bind(r,n,a,t),g=L.bind(r,a,t),w=j.bind(r,n,a,t),p.onerror=y,p.onmessage=E,p.onopen=C,p.onclose=S,r.onicecandidate=o,r.onaddstream=s,r.onremovestream=h,r.onnegotiationneeded=m,r.oniceconnectionstatechange=v,r.ondatachannel=g,r.onsignalingstatechange=w):(r=new e.RTCPeerConnection(c,l),o=P.bind(r,n,a,t),s=x.bind(r,a),h=U.bind(r,a),m=q.bind(r,n,a,t),v=_.bind(r,n,a,t),g=L.bind(r,a,t),w=j.bind(r,n,a,t),r.onicecandidate=o,r.onaddstream=s,r.onremovestream=h,r.onnegotiationneeded=m,r.oniceconnectionstatechange=v,r.ondatachannel=g,r.onsignalingstatechange=w),u[a][t]=r},F=function(n,a){a?n.sendTo(g,{type:"create-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},V=function(n,a){a?n.sendTo(g,{type:"join-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},B=function(n){if(n){var a=Y.bind(this,n);e.getUserMedia(o,a,S)}else e.console.error("theComunicator is not provided")},G=function(n,a,t){if(a&&r)if(h[a]===n.whoAmI())if(t)u[a][t].addStream(r);else for(var i,o=Object.keys(u[a]),s=0,c=o.length;c>s;s+=1)i=o[s],i&&u[a][i].addStream(r);else u[a][h[a]].addStream(r);else e.console.error(r?"Missing mandatory field <channel>":"You must call Signaler.getUserMedia() before streamOnChannel.")},H=function(n,a,t){n&&a&&f&&f[n]&&f[n][a]?f[n][a].send(t):e.console.error("Missing mandatory fields <channel>, <who> or there is no data-channel for user",a,"in channel",n)},J=function(e,n){if(e&&f&&f[e])for(var a,t,i=Object.keys(f[e]),r=i.length,o=0;r>o;o+=1)a=i[o],a&&(t=f[e][a],t&&t.send(n))},K=function(n,a,t){a&&t&&h[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"approve",channel:a},!0)):e.console.warn("cause","Please review your code")},Q=function(n,a,t){a&&t&&h[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"un-approve",channel:a},!0)):e.console.warn("cause","Please review your code")},W=function(n,a){if(a&&a.detail&&a.detail.what&&a.detail.what.type){var t,i,o,s=a.detail,c=a.detail.what.type;switch(c){case"do-handshake":s.whoami&&s.what.channel?(h[s.what.channel]=s.who,z(n,s.what.channel,s.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"take-offer":s.whoami&&s.what.channel&&s.what.offer?(u[s.what.channel]&&u[s.what.channel][s.whoami]||(z(n,s.what.channel,s.whoami),h[s.what.channel]=s.whoami),N.call(u[s.what.channel][s.whoami],n,s.what.channel,s.whoami,s.what.offer)):e.console.error("Missing mandatory fields: <eventArrived.whoami>, <eventArrived.what.channel> and <eventArrived.what.offer>");break;case"take-answer":R.call(u[s.what.channel][s.whoami],n,s.what.channel,s.whoami,s.what.answer);break;case"take-candidates":if(s.what.candidates)for(t=0,i=k.bind(u[s.what.channel][s.whoami],n,s.what.channel,s.whoami);t<s.what.candidates.length;t+=1)u[s.what.channel][s.whoami].addIceCandidate(new e.RTCIceCandidate(s.what.candidates[t]),i,C);break;case"initiator-quit":X(n,s.what.channel,!0);break;case"slave-quit":u[s.what.channel]&&u[s.what.channel][s.whoami]&&(u[s.what.channel][s.whoami].close(),delete u[s.what.channel][s.whoami]),f[s.what.channel]&&f[s.what.channel][s.whoami]&&f[s.what.channel][s.whoami].close();break;case"approved":s.whoami&&s.what.channel?(v[s.what.channel]||(v[s.what.channel]=[]),v[s.what.channel].push(s.whoami),z(n,s.what.channel,s.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"un-approved":s.whoami&&s.what.channel?(o=v[s.what.channel].indexOf(s.whoami),o>=0&&(v[s.what.channel].splice(o,1),u[s.what.channel][s.whoami].close(),f[s.what.channel][s.whoami].close(),delete u[s.what.channel][s.whoami],delete f[s.what.channel][s.whoami])):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"you-are-un-approved":s.what.channel&&s.what.users?s.what.users.forEach(function(e){u[s.what.channel]&&u[s.what.channel][e]&&(u[s.what.channel][e].removeStream(r),u[s.what.channel][e].close(),f[s.what.channel][e].close(),delete u[s.what.channel][e],delete f[s.what.channel][e])}):e.console.error("Missing mandatory field: <eventArrived.what.channel> and <eventArrived.what.users>");break;default:e.console.error("Event valid but un-manageable. Target:",a.detail)}}else e.console.error("Event arrived is somehow invalid. Target:",a)},X=function(n,a,t){if(a)if(u[a]){for(var i,o=u[a],s=Object.keys(o),c=s.length,l=0;c>l;l+=1)i=s[l],u[a]&&u[a][i]&&u[a][i].close(),f[a]&&f[a][i]&&f[a][i].close();!t&&r&&(r.stop(),r=void 0),delete h[a],delete u[a],delete v[a],n.sendTo(g,{type:"leave-channel",channel:a},!0),e.removeEventListener("comunicator:to-me",W,!1)}else e.console.info("No peers in specified channel",a);else e.console.error("Missing mandatory parameter <channel>")},Z=function(n,a){var t=F.bind(this,a),i=V.bind(this,a),o=B.bind(this,a),s=G.bind(this,a),c=H.bind(this),l=J.bind(this),d=K.bind(this,a),h=Q.bind(this,a),m=X.bind(this,a),u=W.bind(this,a),f={userIsPresent:a.userIsPresent,createChannel:t,joinChannel:i,getUserMedia:o,streamOnChannel:s,sendTo:c,broadcast:l,approve:d,unApprove:h,leaveChannel:m};Object.defineProperties(f,{myStream:{get:function(){return r}}}),e.addEventListener("comunicator:to-me",u,!1),n(f)},ee=function(e){i.then(Z.bind(this,e))};return n&&e.Comunicator?n instanceof e.Promise?i=n:("string"==typeof n||n instanceof String)&&(i=new e.Comunicator(n)):e.console.error("Missing mandatory <url> parameter or Comunicator (http://github.com/720kb/comunicator) not present."),a&&(o=a),t&&(s=t),e._getPeers=function(){return u},e._getDataChannels=function(){return f},e._getIceCandidates=function(){return m},e._getInititators=function(){return h},e._getApprovedUsers=function(){return v},new e.Promise(ee.bind(this))};e.Signaler=n}(window),function(e,n){"use strict";e.module("720kb.signaler",[]).provider("Signaler",function(){var e,a=function(a,t,i){e=new n(a,t,i)};return{initSignaler:a,$get:["$rootScope","$window","$log",function(n,a,t){var i=function(e){e&&e.detail&&n.$apply(function(n){t.debug("signaler:usermedia-error"),n.$emit("signaler:usermedia-error",e.detail)})},r=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:data-arrived"),n.$emit("signaler:data-arrived",e.detail)}):t.error("Missing mandatory event")},o=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:datachannel-opened"),n.$emit("signaler:datachannel-opened",e.detail)}):t.error("Missing mandatory event")},s=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:datachannel-closed"),n.$emit("signaler:datachannel-closed",e.detail)}):t.error("Missing mandatory event")},c=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:ready"),n.$emit("signaler:ready",e.detail)}):t.error("Missing mandatory event")},l=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:stream",e.detail)}):t.error("Missing mandatory event")},d=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:end",e.detail)}):t.error("Missing mandatory event")},h=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:my-stream",e.detail)}):t.error("Missing mandatory event")};return a.addEventListener("signaler:usermedia-error",i,!1),a.addEventListener("signaler:data-arrived",r,!1),a.addEventListener("signaler:datachannel-opened",o,!1),a.addEventListener("signaler:datachannel-closed",s,!1),a.addEventListener("signaler:ready",c,!1),a.addEventListener("signaler:stream",l,!1),a.addEventListener("signaler:end",d,!1),a.addEventListener("signaler:my-stream",h,!1),n.$on("$destroy",function(){a.removeEventListener("signaler:usermedia-error",i,!1),a.removeEventListener("signaler:data-arrived",r,!1),a.removeEventListener("signaler:datachannel-opened",o,!1),a.removeEventListener("signaler:datachannel-closed",s,!1),a.removeEventListener("signaler:ready",c,!1),a.removeEventListener("signaler:stream",l,!1),a.removeEventListener("signaler:end",d,!1),a.removeEventListener("signaler:my-stream",h,!1)}),e}]}})}(angular,Signaler);
//# sourceMappingURL=signaler-angular.min.js.map