/*
 * siglr
 *
 * 
 * https://github.com/720kb/signaler
 * Dario Andrei <wouldgo84@gmail.com>
 * 
 * MIT license
 * 2015-10-10T23:25:33.271Z
 */
!function(e){"use strict";var n=function(n,a,t,i){var r,o,s,c={audio:!0,video:!0},l={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},d={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:23.21.150.121"}]},h={},m={},u={},f={},v={},g={},w={},p="unknown-peer",b=function(n){var a=new e.CustomEvent("signaler:error",{detail:n});e.dispatchEvent(a)},y=function(n){e.console.error(n),b(n)},E=function(n){e.console.error(n),b(n)},C=function(n,a,t){e.console.error(n,a,t),b(t)},S=function(n){e.console.error(n),b(n)},k=function(n){e.console.error(n),b(n)},$=function(n){e.console.error(n),b(n)},A=function(n){e.console.error(n);var a=new e.CustomEvent("signaler:usermedia-error",{detail:n});e.dispatchEvent(a)},M=function(n,a,t){o&&e.console.info("iceCandidate for",t,"in",a,"successfully added")},L=function(n,a,t){if(n&&a&&t&&t.data){if(("string"==typeof t.data||t.data instanceof String)&&t.data.indexOf("_signaler")>=0)switch(t.data){case"_signaler:got-stream?":s&&v[n]&&v[n][a]&&v[n][a].addStream(s);break;default:e.console.error("Not interesting event atm")}else{var i={payload:t.data,whoami:a,channel:n},r=new e.CustomEvent("signaler:data-arrived",{detail:i});e.dispatchEvent(r)}o&&e.console.debug(t.data)}else e.console.error("Missing mandatory fields <channel>, <who> or data channel event not valid")},T=function(n,a){var t={whoami:a,channel:n},i=new e.CustomEvent("signaler:datachannel-opened",{detail:t});g[n][a]=this,w[n]&&w[n].indexOf(a)>=0&&this.send("_signaler:got-stream?"),e.dispatchEvent(i),o&&e.console.info("Data channel",this,"opened...")},O=function(n,a){var t={whoami:a,channel:n},i=new e.CustomEvent("signaler:datachannel-closed",{detail:t});delete g[n][a],0===Object.keys(g[n])&&delete g[n],e.dispatchEvent(i),o&&e.console.info("Data channel",this,"closed.")},D=function(n,a,t){if(n&&a&&t&&t.channel){var i=C.bind(t.channel,n,a),r=L.bind(t.channel,n,a),o=T.bind(t.channel,n,a),s=O.bind(t.channel,n,a);t.channel.onerror=i,t.channel.onmessage=r,t.channel.onopen=o,t.channel.onclose=s}else e.console.error("Missing mandatory fields <channel>, <who> or event not present")},I=function(n,a,t,i,r){if(o&&e.console.debug("Set local description",r),!r||"offer"!==r&&"answer"!==r)e.console.error("Type not recognized:",r);else{var s={type:r,channel:t};s[r]=i,n.sendTo(a,s,!0)}},R=function(n,a,t,i){var r=I.bind(this,n,t,a,i,"answer");this.setLocalDescription(new e.RTCSessionDescription(i),r,E)},N=function(n,a,t,i){if(o&&e.console.debug("Set remote description",i),i&&"slave"===i){var r=R.bind(this,n,a,t);this.createAnswer(r,k,l)}else i&&"master"===i&&o&&e.console.info("handshake finished")},P=function(n,a,t,i){var r=I.bind(this,n,t,a,i,"offer");this.setLocalDescription(new e.RTCSessionDescription(i),r,E)},j=function(n,a,t,i){var r=N.bind(this,n,a,t,"master");this.setRemoteDescription(new e.RTCSessionDescription(i),r,S)},_=function(n,a,t,i){var r=N.bind(this,n,a,t,"slave");this.setRemoteDescription(new e.RTCSessionDescription(i),r,S)},x=function(n,a,t,i){if(a){if(i.candidate)f[a]||(f[a]={}),f[a][t]||(f[a][t]=[]),f[a][t].push(i.candidate),o&&e.console.trace("generating a candidate");else if(f[a]&&f[a][t]&&Array.isArray(f[a][t])){var r=f[a][t];n.sendTo(t,{type:"use-ice-candidates",channel:a,candidates:r.splice(0,r.length)},!0),o&&e.console.trace("From",n.whoAmI(),"to",t,"-> use candidates",r.length)}}else e.console.error("channel invalid or event.candidate null")},U=function(n,a,t,i){if(i&&i.target&&i.target.signalingState)switch(i.target.signalingState){default:o&&e.console.info("signaling state not interesting atm",i.target.signalingState)}else e.console.error("signaling state changed without event value")},q=function(n,a,t,i){var r;if(i&&i.target&&i.target.iceConnectionState)switch(i.target.iceConnectionState){case"connected":case"completed":r=new e.CustomEvent("signaler:ready",{detail:{channel:a,whoami:t}}),e.dispatchEvent(r);break;default:o&&e.console.info("ice state not interesting atm.",i.target.iceConnectionState)}else e.console.error("ice connection state changed without event value")},Y=function(n,a){if(a.stream)for(var t,i,r=Object.keys(v[n]),o=0,s=r.length;s>o;o+=1)t=r[o],v[n][t]===this&&(i=new e.CustomEvent("signaler:stream",{detail:{userid:t,stream:a.stream}}),e.dispatchEvent(i));else e.console.error("No stream arrived")},z=function(n,a){if(a.stream)for(var t,i,r=Object.keys(v[n]),o=0,s=r.length;s>o;o+=1)t=r[o],v[n][t]===this&&(i=new e.CustomEvent("signaler:end",{detail:{userid:t}}),e.dispatchEvent(i));else e.console.error("No stream arrived")},F=function(n,a,t){if(u[a]===n.whoAmI()||s||w[a]&&w[a].indexOf(t)>=0){var i=P.bind(this,n,a,t);this.createOffer(i,y)}else o&&e.console.info("You can not negotiate a p2p connection")},V=function(n,a){var t;s||(t=new e.CustomEvent("signaler:my-stream",{detail:{userid:n.whoAmI(),stream:a}}),s=a,e.dispatchEvent(t))},B=function(n,a,t,i){var r,o,s,c,l,u,f,w,p,b,y,E,S;v[a]||(v[a]={}),g[a]||(g[a]={}),i?(r=new e.RTCPeerConnection(d,h),p=r.createDataChannel("signaler-datachannel",m),b=C.bind(p,a,t),y=L.bind(p,a,t),E=T.bind(p,a,t),S=O.bind(p,a,t),o=x.bind(r,n,a,t),s=Y.bind(r,a),c=z.bind(r,a),l=F.bind(r,n,a,t),u=q.bind(r,n,a,t),f=D.bind(r,a,t),w=U.bind(r,n,a,t),p.onerror=b,p.onmessage=y,p.onopen=E,p.onclose=S,r.onicecandidate=o,r.onaddstream=s,r.onremovestream=c,r.onnegotiationneeded=l,r.oniceconnectionstatechange=u,r.ondatachannel=f,r.onsignalingstatechange=w):(r=new e.RTCPeerConnection(d,h),o=x.bind(r,n,a,t),s=Y.bind(r,a),c=z.bind(r,a),l=F.bind(r,n,a,t),u=q.bind(r,n,a,t),f=D.bind(r,a,t),w=U.bind(r,n,a,t),r.onicecandidate=o,r.onaddstream=s,r.onremovestream=c,r.onnegotiationneeded=l,r.oniceconnectionstatechange=u,r.ondatachannel=f,r.onsignalingstatechange=w),v[a][t]=r},G=function(n,a){a?n.sendTo(p,{type:"create-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},H=function(n,a){a?n.sendTo(p,{type:"join-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},J=function(n){if(n){var a=V.bind(this,n);e.getUserMedia(c,a,A)}else e.console.error("theComunicator is not provided")},K=function(n,a,t){if(a&&s)if(u[a]===n.whoAmI())if(t)v[a][t].addStream(s);else for(var i,r=Object.keys(v[a]),o=0,c=r.length;c>o;o+=1)i=r[o],i&&v[a][i].addStream(s);else v[a][u[a]].addStream(s);else e.console.error(s?"Missing mandatory field <channel>":"You must call Signaler.getUserMedia() before streamOnChannel.")},Q=function(n,a,t){n&&a&&g&&g[n]&&g[n][a]?g[n][a].send(t):e.console.error("Missing mandatory fields <channel>, <who> or there is no data-channel for user",a,"in channel",n)},W=function(e,n){if(e&&g&&g[e])for(var a,t,i=Object.keys(g[e]),r=i.length,o=0;r>o;o+=1)a=i[o],a&&(t=g[e][a],t&&t.send(n))},X=function(n,a,t){a&&t&&u[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"approve",channel:a},!0)):e.console.warn("cause","Please review your code")},Z=function(n,a,t){a&&t&&u[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"un-approve",channel:a},!0)):e.console.warn("cause","Please review your code")},ee=function(n,a){if(a&&a.detail&&a.detail.what&&a.detail.what.type){var t,i,r,o=a.detail,c=a.detail.what.type;switch(c){case"do-handshake":o.whoami&&o.what.channel?(u[o.what.channel]=o.who,B(n,o.what.channel,o.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"take-offer":o.whoami&&o.what.channel&&o.what.offer?(v[o.what.channel]&&v[o.what.channel][o.whoami]||(B(n,o.what.channel,o.whoami),u[o.what.channel]=o.whoami),_.call(v[o.what.channel][o.whoami],n,o.what.channel,o.whoami,o.what.offer)):e.console.error("Missing mandatory fields: <eventArrived.whoami>, <eventArrived.what.channel> and <eventArrived.what.offer>");break;case"take-answer":j.call(v[o.what.channel][o.whoami],n,o.what.channel,o.whoami,o.what.answer);break;case"take-candidates":if(o.what.candidates)for(t=0,i=M.bind(v[o.what.channel][o.whoami],n,o.what.channel,o.whoami);t<o.what.candidates.length;t+=1)v[o.what.channel][o.whoami].addIceCandidate(new e.RTCIceCandidate(o.what.candidates[t]),i,$);break;case"initiator-quit":ne(n,o.what.channel,!0);break;case"slave-quit":v[o.what.channel]&&v[o.what.channel][o.whoami]&&(v[o.what.channel][o.whoami].close(),delete v[o.what.channel][o.whoami]),g[o.what.channel]&&g[o.what.channel][o.whoami]&&g[o.what.channel][o.whoami].close();break;case"approved":o.whoami&&o.what.channel?(w[o.what.channel]||(w[o.what.channel]=[]),w[o.what.channel].push(o.whoami),B(n,o.what.channel,o.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"un-approved":o.whoami&&o.what.channel?(r=w[o.what.channel].indexOf(o.whoami),r>=0&&(w[o.what.channel].splice(r,1),v[o.what.channel][o.whoami].close(),g[o.what.channel][o.whoami].close(),delete v[o.what.channel][o.whoami],delete g[o.what.channel][o.whoami])):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"you-are-un-approved":o.what.channel&&o.what.users?o.what.users.forEach(function(e){v[o.what.channel]&&v[o.what.channel][e]&&(v[o.what.channel][e].removeStream(s),v[o.what.channel][e].close(),g[o.what.channel][e].close(),delete v[o.what.channel][e],delete g[o.what.channel][e])}):e.console.error("Missing mandatory field: <eventArrived.what.channel> and <eventArrived.what.users>");break;default:e.console.error("Event valid but un-manageable. Target:",a.detail)}}else e.console.error("Event arrived is somehow invalid. Target:",a)},ne=function(n,a,t){if(a)if(v[a]){for(var i,r=v[a],c=Object.keys(r),l=c.length,d=0;l>d;d+=1)i=c[d],v[a]&&v[a][i]&&v[a][i].close(),g[a]&&g[a][i]&&g[a][i].close();!t&&s&&(s.stop(),s=void 0),delete u[a],delete v[a],delete w[a],n.sendTo(p,{type:"leave-channel",channel:a},!0),e.removeEventListener("comunicator:to-me",ee,!1)}else o&&e.console.info("No peers in specified channel",a);else e.console.error("Missing mandatory parameter <channel>")},ae=function(n,a){var t=G.bind(this,a),i=H.bind(this,a),r=J.bind(this,a),o=K.bind(this,a),c=Q.bind(this),l=W.bind(this),d=X.bind(this,a),h=Z.bind(this,a),m=ne.bind(this,a),u=ee.bind(this,a),f={userIsPresent:a.userIsPresent,createChannel:t,joinChannel:i,getUserMedia:r,streamOnChannel:o,sendTo:c,broadcast:l,approve:d,unApprove:h,leaveChannel:m};Object.defineProperties(f,{myStream:{get:function(){return s}}}),e.addEventListener("comunicator:to-me",u,!1),n(f)},te=function(e){r.then(ae.bind(this,e))};return n&&e.Comunicator?n instanceof e.Promise?r=n:("string"==typeof n||n instanceof String)&&(r=new e.Comunicator(n)):e.console.error("Missing mandatory <url> parameter or Comunicator (http://github.com/720kb/comunicator) not present."),a&&(c=a),t&&(l=t),o=i?i:!1,e._getPeers=function(){return v},e._getDataChannels=function(){return g},e._getIceCandidates=function(){return f},e._getInititators=function(){return u},e._getApprovedUsers=function(){return w},new e.Promise(te.bind(this))};e.Signaler=n}(window),function(e,n){"use strict";e.module("720kb.signaler",[]).provider("Signaler",function(){var e,a=function(a,t,i,r){e=new n(a,t,i,r)};return{initSignaler:a,$get:["$rootScope","$window","$log",function(n,a,t){var i=function(e){e&&e.detail&&n.$apply(function(n){t.debug("signaler:error"),n.$emit("signaler:error",e.detail)})},r=function(e){e&&e.detail&&n.$apply(function(n){t.debug("signaler:usermedia-error"),n.$emit("signaler:usermedia-error",e.detail)})},o=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:data-arrived"),n.$emit("signaler:data-arrived",e.detail)}):t.error("Missing mandatory event")},s=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:datachannel-opened"),n.$emit("signaler:datachannel-opened",e.detail)}):t.error("Missing mandatory event")},c=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:datachannel-closed"),n.$emit("signaler:datachannel-closed",e.detail)}):t.error("Missing mandatory event")},l=function(e){e&&e.detail?n.$apply(function(n){t.debug("signaler:ready"),n.$emit("signaler:ready",e.detail)}):t.error("Missing mandatory event")},d=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:stream",e.detail)}):t.error("Missing mandatory event")},h=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:end",e.detail)}):t.error("Missing mandatory event")},m=function(e){e&&e.detail?n.$apply(function(n){n.$emit("signaler:my-stream",e.detail)}):t.error("Missing mandatory event")};return a.addEventListener("signaler:error",i,!1),a.addEventListener("signaler:usermedia-error",r,!1),a.addEventListener("signaler:data-arrived",o,!1),a.addEventListener("signaler:datachannel-opened",s,!1),a.addEventListener("signaler:datachannel-closed",c,!1),a.addEventListener("signaler:ready",l,!1),a.addEventListener("signaler:stream",d,!1),a.addEventListener("signaler:end",h,!1),a.addEventListener("signaler:my-stream",m,!1),n.$on("$destroy",function(){a.removeEventListener("signaler:error",i,!1),a.removeEventListener("signaler:usermedia-error",r,!1),a.removeEventListener("signaler:data-arrived",o,!1),a.removeEventListener("signaler:datachannel-opened",s,!1),a.removeEventListener("signaler:datachannel-closed",c,!1),a.removeEventListener("signaler:ready",l,!1),a.removeEventListener("signaler:stream",d,!1),a.removeEventListener("signaler:end",h,!1),a.removeEventListener("signaler:my-stream",m,!1)}),e}]}})}(angular,Signaler);
//# sourceMappingURL=signaler-angular.min.js.map