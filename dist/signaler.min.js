/*
 * siglr - v1.1.3
 *
 * 
 * https://github.com/wouldgo/signaler
 * MIT license
 * 2015-06-18T19:48:55.459Z
 */


!function(e){"use strict";var n=function(n,a,t,o,i,c,s){var r,h,l,d,w="unknown-peer",u={},m={},f={},v={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},p={iceServers:[{url:"stun:stun.l.google.com:19302"}]},g={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]},b={},y={audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"}},video:!0},C=function(n){e.console.warn("cause",n)},E=function(n){if(n&&n.data){e.console.info(n.data);var a=new e.CustomEvent("stream:data-arrived",{detail:n.data});e.dispatchEvent(a)}else e.console.warn("cause","Data channel event not valid")},T=function(){e.console.info("Data channel",this,"opened...")},S=function(){e.console.info("Data channel",this,"closed.")},k=function(n){n&&n.channel?(n.channel.onerror=C,n.channel.onmessage=E,n.channel.onopen=T,n.channel.onclose=S):e.console.warn("cause","Event or event channel not present")},R=function(n){e.console.warn("cause",n)},D=function(n){e.console.warn("cause",n)},j=function(n){e.console.warn("cause",n)},O=function(n){e.console.warn("cause",n)},I=function(n){e.console.warn("cause",n)},P=function(){e.console.debug("IceCandidate successfully added.")},A=function(n){e.console.warn("cause",n)},N=function(n,a){if(a.stream)for(var t,o,i,c=Object.keys(m[n]),s=0,r=c.length;r>s;s+=1)t=c[s],m[n][t]===this&&(o={userid:t,mediaElement:a.stream},i=new e.CustomEvent("stream:arrive",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},L=function(n,a){if(a.stream)for(var t,o,i,c=Object.keys(m[n]),s=0,r=c.length;r>s;s+=1)t=c[s],m[n][t]===this&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},M=function(n,a){if(a.target&&e.console.debug("Ice state:",a.target.iceConnectionState),a.target&&"disconnected"===a.target.iceConnectionState)for(var t,o,i,c=m[n],s=Object.keys(c),r=s.length,h=0;r>h;h+=1)t=s[h],a.target===m[n][t]&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i),delete m[n][t])},U=function(e,n,a){e.sendTo(n,{type:"use-ice-candidates",channel:a})},F=function(n,a,t,o){var i=U.bind(this,n,t,o);this.setRemoteDescription(new e.RTCSessionDescription(a),i,I)},G=function(n,a,t,o){o.candidate&&a?n.sendTo(t,{type:"ice-candidate",channel:a,candidate:o.candidate}):e.console.debug("Event arrived, channel or user invalid")},H=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"answer",channel:a,answer:o}),n.sendTo(t,{type:"use-ice-candidates",channel:a})},O)},K=function(e,n,a){var t=H.bind(this,e,n,a);this.createAnswer(t,j,v)},V=function(n,a,t,o){var i=K.bind(this,n,a,t);this.setRemoteDescription(new e.RTCSessionDescription(o),i,I)},q=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"open",channel:a,offer:o})},O)},x=function(e,n,a){var t=q.bind(this,e,n,a);l&&!this.singleton&&(this.singleton=!0,this.createOffer(t,D))},z=function(n,a,t,o){var i,c;l||(l=o,i=new e.CustomEvent("stream:my-stream",{detail:o}),e.dispatchEvent(i)),t!==w&&m[a][t]?(c=x.bind(m[a][t],n,a,t),m[a][t].onnegotiationneeded=c,m[a][t].addStream(l)):r.addStream(l)},B=function(n,a,t){var o,i=new e.RTCPeerConnection(p,g);i.onicecandidate=G.bind(i,n,a,t),i.onaddstream=N.bind(i,a),i.onremovestream=L.bind(i,a),i.onnegotiationneeded=x.bind(i,n,a,t),i.oniceconnectionstatechange=M.bind(i,a),i.ondatachannel=k,o=i.createDataChannel("signaler-datachannel",b),o.onerror=C,o.onmessage=E,o.onopen=T,o.onclose=S,m[a]||(m[a]={}),f[a]||(f[a]={}),t===w?(r=i,h=o):(m[a][t]=i,f[a][t]=o)},J=function(n,a){if(a&&a.detail&&a.detail.what.type){var t,o,i,c,s,d,w,v,p,g,b,y,C=a.detail,E=0;switch(C.what.type){case"offer":C.what.offer?(u[C.what.channel]||(u[C.what.channel]=C.whoami),r&&(m[C.what.channel][C.whoami]=r,f[C.what.channel][C.whoami]=h,m[C.what.channel][C.whoami].onicecandidate=G.bind(m[C.what.channel][C.whoami],n,C.what.channel,C.whoami),r=void 0,h=void 0),V.call(m[C.what.channel][C.whoami],n,C.what.channel,C.whoami,C.what.offer)):e.console.error("No payload");break;case"answer":C.what.answer&&C.whoami?(r&&(m[C.what.channel][C.whoami]=r,f[C.what.channel][C.whoami]=h,m[C.what.channel][C.whoami].onicecandidate=G.bind(m[C.what.channel][C.whoami],n,C.what.channel,C.whoami),r=void 0,h=void 0),F.call(m[C.what.channel][C.whoami],n,C.what.answer,C.whoami,C.what.channel)):e.console.warn("No payload or user identification");break;case"candidate":if(C.what.candidate&&C.what.candidate.length>0)for(t=C.what.candidate.length,E=0;t>E;E+=1)o=C.what.candidate[E],m[C.what.channel][C.whoami].addIceCandidate(new e.RTCIceCandidate(o),P,A);break;case"p2p-is-instantiated":m[C.what.channel][C.whoami]||(r=void 0,h=void 0,B(n,C.what.channel,C.whoami)),n.sendTo(C.whoami,{type:"join-channel",channel:C.what.channel});break;case"instantiate-p2p":l?(B(n,C.what.channel,C.whoami),z(n,C.what.channel,C.whoami,l)):e.console.error("User stream [myStream] is not defined...");break;case"redo-join":n.sendTo(C.whoami,{type:"join-channel",channel:C.what.channel});break;case"approved":for(i=C.what.listeners,c=i.length,s=0;c>s;s+=1)d=i[s],d&&(m[C.what.channel][d]?(m[C.what.channel][d].singleton=!1,m[C.what.channel][d].addStream(l)):(B(n,C.what.channel,d),z(n,C.what.channel,d,l)));break;case"un-approved":for(w=m[C.what.channel],v=Object.keys(w),p=v.length,g=u[C.what.channel],b=0;p>b;b+=1)y=v[b],y!==String(g)&&(m[C.what.channel][y].singleton=!1,m[C.what.channel][y].removeStream(l));break;default:e.console.warn("cause","Event valid but un-manageable","target",a.detail)}}else e.console.warn("cause","Event arrived is somehow invalid","target",a)},Q=function(n,a){if(a&&d&&d.whoReallyAmI){var t=z.bind(this,n,a,w);u[a]=d.whoReallyAmI,B(n,a,w),e.getUserMedia(y,t,R)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},W=function(n,a){a?(B(n,a,w),n.sendTo(w,{type:"join-channel",channel:a})):e.console.warn("cause","Please provide channel name")},X=function(n,a){if(a){var t=z.bind(this,n,a,u[a]);e.getUserMedia(y,t,R)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},Y=function(n,a,t){a&&d.whoReallyAmI&&t&&u[a]===d.whoReallyAmI?n.sendTo(t,{type:"approve",channel:a}):e.console.warn("cause","Please review your code")},Z=function(n,a,t){a&&t?n.sendTo(t,{type:"un-approve",channel:a}):e.console.warn("cause","Please review your code")},$=function(n,a){if(a){r&&r.close(),h&&h.close();for(var t,o=m[a],i=Object.keys(o),c=i.length,s=0;c>s;s+=1)t=i[s],m[a][t]&&(m[a][t].close(),f[a][t].close());r=void 0,h=void 0,l&&l.stop(),l=void 0,delete u[a],delete m[a],n.broadcast({type:"leave-channel",channel:a}),e.removeEventListener("comunicator:to-me",J,!1)}else e.console.warn("cause","Please provide channel name")},_=function(){for(var e,n,a,t,o,i,c,s=Object.keys(f),r=0,h=s.length,l={};h>r;r+=1)if(n=s[r],n&&(l[n]||(l[n]={}),e=f[n]))for(a=Object.keys(e),t=0,o=a.length;o>t;t+=1)i=a[t],i&&(c=e[i],c&&"open"===c.readyState&&(l[n][i]=c));return l},ee=function(n,a){e.addEventListener("comunicator:to-me",J.bind(this,a),!1),n({userIsPresent:a.userIsPresent,createChannel:Q.bind(this,a),joinChannel:W.bind(this,a),streamOnChannel:X.bind(this,a),approve:Y.bind(this,a),unApprove:Z.bind(this,a),leaveChannel:$.bind(this,a),dataChannels:_.bind(this)})},ne=function(e){d.promise(n).then(ee.bind(this,e))};return a&&n&&e.Comunicator?d=new e.Comunicator(a,!0):e.console.warn("cause","Missing mandatory <url> parameters or comunicator not present."),t&&(y=t),o&&(v=o),i&&(p=i),c&&(g=c),s&&(b=s),new Promise(ne.bind(this))};e.Signaler=n}(window);
//# sourceMappingURL=signaler.min.js.map