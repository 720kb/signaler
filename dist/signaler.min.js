/*
 * siglr - v2.2.3
 *
 * 
 * https://github.com/720kb/signaler
 * MIT license
 * 2015-07-13T21:11:25.173Z
 */


!function(e,n){"use strict";var a=function(a,t,o,i,c,s){var r,h,l,d,w="unknown-peer",u={},f={},m={},v={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},p={iceServers:[{url:"stun:stun.l.google.com:19302"}]},g={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]},b={},y={audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"}},video:!0},C=function(n){e.console.warn("cause",n)},E=function(n){if(n&&n.data){e.console.info(n.data);var a=new e.CustomEvent("stream:data-arrived",{detail:n.data});e.dispatchEvent(a)}else e.console.warn("cause","Data channel event not valid")},S=function(){var n=new e.CustomEvent("stream:datachannel-opened");e.dispatchEvent(n),e.console.info("Data channel",this,"opened...")},T=function(){e.console.info("Data channel",this,"closed.")},k=function(n){n&&n.channel?(n.channel.onerror=C,n.channel.onmessage=E,n.channel.onopen=S,n.channel.onclose=T):e.console.warn("cause","Event or event channel not present")},D=function(n){e.console.warn("cause",n)},j=function(n){e.console.warn("cause",n)},O=function(n){e.console.warn("cause",n)},P=function(n){e.console.warn("cause",n)},R=function(n){e.console.warn("cause",n)},I=function(){e.console.debug("IceCandidate successfully added.")},A=function(n){e.console.warn("cause",n)},N=function(n,a){if(a.stream)for(var t,o,i,c=Object.keys(f[n]),s=0,r=c.length;r>s;s+=1)t=c[s],f[n][t]===this&&(o={userid:t,mediaElement:a.stream},i=new e.CustomEvent("stream:arrive",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},L=function(n,a){if(a.stream)for(var t,o,i,c=Object.keys(f[n]),s=0,r=c.length;r>s;s+=1)t=c[s],f[n][t]===this&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i));else e.console.warn("cause","No stream arrived")},M=function(n,a){if(a.target&&e.console.debug("Ice state:",a.target.iceConnectionState),a.target&&"disconnected"===a.target.iceConnectionState)for(var t,o,i,c=f[n],s=Object.keys(c),r=s.length,h=0;r>h;h+=1)t=s[h],a.target===f[n][t]&&(o={userid:t},i=new e.CustomEvent("stream:end",{detail:o}),e.dispatchEvent(i),delete f[n][t])},U=function(e,n,a){e.sendTo(n,{type:"use-ice-candidates",channel:a},!0)},F=function(n,a,t,o){var i=U.bind(this,n,t,o);this.setRemoteDescription(new e.RTCSessionDescription(a),i,R)},G=function(n,a,t,o){o.candidate&&a?n.sendTo(t,{type:"ice-candidate",channel:a,candidate:o.candidate},!0):e.console.debug("Event arrived, channel or user invalid")},H=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"answer",channel:a,answer:o},!0),n.sendTo(t,{type:"use-ice-candidates",channel:a},!0)},P)},K=function(e,n,a){var t=H.bind(this,e,n,a);this.createAnswer(t,O,v)},V=function(n,a,t,o){var i=K.bind(this,n,a,t);this.setRemoteDescription(new e.RTCSessionDescription(o),i,R)},q=function(n,a,t,o){this.setLocalDescription(new e.RTCSessionDescription(o),function(){n.sendTo(t,{type:"open",channel:a,offer:o},!0)},P)},x=function(e,n,a){var t=q.bind(this,e,n,a);l&&!this.singleton&&(this.singleton=!0,this.createOffer(t,j))},z=function(n,a,t,o){var i,c;l||(l=o,i=new e.CustomEvent("stream:my-stream",{detail:o}),e.dispatchEvent(i)),f[a][t]?(c=x.bind(f[a][t],n,a,t),f[a][t].onnegotiationneeded=c,f[a][t].addStream(l)):r.addStream(l)},B=function(n,a,t){var o,i=new e.RTCPeerConnection(p,g);i.onicecandidate=G.bind(i,n,a,t),i.onaddstream=N.bind(i,a),i.onremovestream=L.bind(i,a),i.onnegotiationneeded=x.bind(i,n,a,t),i.oniceconnectionstatechange=M.bind(i,a),i.ondatachannel=k,o=i.createDataChannel("signaler-datachannel",b),o.onerror=C,o.onmessage=E,o.onopen=S,o.onclose=T,f[a]||(f[a]={}),m[a]||(m[a]={}),t===w?(r=i,h=o):(f[a][t]=i,m[a][t]=o)},J=function(n,a){if(a&&a.detail&&a.detail.what.type){var t,o,i,c,s,d,w,v,p,g,b,y,C=a.detail,E=0;switch(C.what.type){case"offer":C.what.offer?(u[C.what.channel]||(u[C.what.channel]=C.whoami),r&&(f[C.what.channel][C.whoami]=r,m[C.what.channel][C.whoami]=h,f[C.what.channel][C.whoami].onicecandidate=G.bind(f[C.what.channel][C.whoami],n,C.what.channel,C.whoami),r=void 0,h=void 0),V.call(f[C.what.channel][C.whoami],n,C.what.channel,C.whoami,C.what.offer)):e.console.error("No payload");break;case"answer":C.what.answer&&C.whoami?(r&&(f[C.what.channel][C.whoami]=r,m[C.what.channel][C.whoami]=h,f[C.what.channel][C.whoami].onicecandidate=G.bind(f[C.what.channel][C.whoami],n,C.what.channel,C.whoami),r=void 0,h=void 0),F.call(f[C.what.channel][C.whoami],n,C.what.answer,C.whoami,C.what.channel)):e.console.warn("No payload or user identification");break;case"candidate":if(C.what.candidate&&C.what.candidate.length>0)for(t=C.what.candidate.length,E=0;t>E;E+=1)o=C.what.candidate[E],f[C.what.channel][C.whoami].addIceCandidate(new e.RTCIceCandidate(o),I,A);break;case"p2p-is-instantiated":f[C.what.channel][C.whoami]||(r=void 0,h=void 0,B(n,C.what.channel,C.whoami)),n.sendTo(C.whoami,{type:"join-channel",channel:C.what.channel},!0);break;case"instantiate-p2p":l?(B(n,C.what.channel,C.whoami),z(n,C.what.channel,C.whoami,l)):e.console.error("User stream [myStream] is not defined...");break;case"redo-join":n.sendTo(C.whoami,{type:"join-channel",channel:C.what.channel},!0);break;case"approved":for(i=C.what.listeners,c=i.length,s=0;c>s;s+=1)d=i[s],d&&(f[C.what.channel][d]?(f[C.what.channel][d].singleton=!1,f[C.what.channel][d].addStream(l)):(B(n,C.what.channel,d),z(n,C.what.channel,d,l)));break;case"un-approved":for(w=f[C.what.channel],v=Object.keys(w),p=v.length,g=u[C.what.channel],b=0;p>b;b+=1)y=v[b],y!==String(g)&&(f[C.what.channel][y].singleton=!1,f[C.what.channel][y].removeStream(l));break;default:e.console.warn("cause","Event valid but un-manageable","target",a.detail)}}else e.console.warn("cause","Event arrived is somehow invalid","target",a)},Q=function(n,a){if(a){var t=z.bind(this,n,a,w);u[a]=n.whoAmI(),B(n,a,w),l?t(l):e.getUserMedia(y,t,D)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},W=function(n,a){a?(B(n,a,w),n.sendTo(w,{type:"join-channel",channel:a},!0)):e.console.warn("cause","Please provide channel name")},X=function(n,a){if(a){var t=z.bind(this,n,a,u[a]);l?t(l):e.getUserMedia(y,t,D)}else e.console.warn("cause","Please provide channel name and user must be notified as present in comunicator")},Y=function(n,a,t){a&&t&&u[a]===n.whoAmI()?n.sendTo(t,{type:"approve",channel:a},!0):e.console.warn("cause","Please review your code")},Z=function(n,a,t){a&&t?n.sendTo(t,{type:"un-approve",channel:a},!0):e.console.warn("cause","Please review your code")},$=function(n,a,t){if(a){r&&r.close(),h&&h.close();for(var o,i=f[a],c=Object.keys(i),s=c.length,d=0;s>d;d+=1)o=c[d],f[a][o]&&(f[a][o].close(),m[a][o].close());r=void 0,h=void 0,!t&&l&&(l.stop(),l=void 0),delete u[a],delete f[a],n.broadcast({type:"leave-channel",channel:a},!0),e.removeEventListener("comunicator:to-me",J,!1)}else e.console.warn("cause","Please provide channel name")},_=function(){for(var e,n,a,t,o,i,c,s=Object.keys(m),r=0,h=s.length,l={};h>r;r+=1)if(n=s[r],n&&(l[n]||(l[n]={}),e=m[n]))for(a=Object.keys(e),t=0,o=a.length;o>t;t+=1)i=a[t],i&&(c=e[i],c&&"open"===c.readyState&&(l[n][i]=c));return l},ee=function(n,a){e.addEventListener("comunicator:to-me",J.bind(this,a),!1),n({userIsPresent:a.userIsPresent,createChannel:Q.bind(this,a),joinChannel:W.bind(this,a),streamOnChannel:X.bind(this,a),approve:Y.bind(this,a),unApprove:Z.bind(this,a),leaveChannel:$.bind(this,a),dataChannels:_.bind(this)})},ne=function(e){d.then(ee.bind(this,e))};return a&&n?a instanceof e.Promise?d=a:("string"==typeof a||a instanceof String)&&(d=new n(a)):e.console.warn("cause","Missing mandatory <url> parameters or comunicator not present."),t&&(y=t),o&&(v=o),i&&(p=i),c&&(g=c),s&&(b=s),new e.Promise(ne.bind(this))};e.Signaler=a}(window,Comunicator);
//# sourceMappingURL=signaler.min.js.map