/*
 * siglr
 *
 * 
 * https://github.com/720kb/signaler
 * Dario Andrei <wouldgo84@gmail.com>
 * 
 * MIT license
 * 2015-09-28T19:26:57.459Z
 */
!function(e){"use strict";var n=function(n,a,t){var o,i,r={audio:!0,video:!0},s={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},c={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:23.21.150.121"}]},h={},l={},d={},w={},f={},m={},u={},v="unknown-peer",g=function(n){e.console.error(n)},b=function(n){e.console.error(n)},p=function(n,a,t){e.console.error(n,a,t)},y=function(n){e.console.error(n)},C=function(n){e.console.error(n)},k=function(n){e.console.error(n)},A=function(n){e.console.error(n);var a=new e.CustomEvent("signaler:usermedia-error",{detail:n});e.dispatchEvent(a)},S=function(n,a,t){e.console.info("iceCandidate for",t,"in",a,"successfully added")},E=function(n,a,t){if(n&&a&&t&&t.data){if(("string"==typeof t.data||t.data instanceof String)&&t.data.indexOf("_signaler")>=0)switch(t.data){case"_signaler:got-stream?":i&&f[n]&&f[n][a]&&f[n][a].addStream(i);break;default:e.console.error("Not interesting event atm")}else{var o={payload:t.data,whoami:a,channel:n},r=new e.CustomEvent("signaler:data-arrived",{detail:o});e.dispatchEvent(r)}e.console.debug(t.data)}else e.console.error("Missing mandatory fields <channel>, <who> or data channel event not valid")},T=function(n,a){var t={whoami:a,channel:n},o=new e.CustomEvent("signaler:datachannel-opened",{detail:t});m[n][a]=this,u[n]&&u[n].indexOf(a)>=0&&this.send("_signaler:got-stream?"),e.dispatchEvent(o),e.console.info("Data channel",this,"opened...")},M=function(n,a){var t={whoami:a,channel:n},o=new e.CustomEvent("signaler:datachannel-closed",{detail:t});delete m[n][a],0===Object.keys(m[n])&&delete m[n],e.dispatchEvent(o),e.console.info("Data channel",this,"closed.")},O=function(n,a,t){if(n&&a&&t&&t.channel){var o=p.bind(t.channel,n,a),i=E.bind(t.channel,n,a),r=T.bind(t.channel,n,a),s=M.bind(t.channel,n,a);t.channel.onerror=o,t.channel.onmessage=i,t.channel.onopen=r,t.channel.onclose=s}else e.console.error("Missing mandatory fields <channel>, <who> or event not present")},D=function(n,a,t,o,i){if(e.console.debug("Set local description",i),!i||"offer"!==i&&"answer"!==i)e.console.error("Type not recognized:",i);else{var r={type:i,channel:t};r[i]=o,n.sendTo(a,r,!0)}},I=function(n,a,t,o){var i=D.bind(this,n,t,a,o,"answer");this.setLocalDescription(new e.RTCSessionDescription(o),i,b)},R=function(n,a,t,o){if(e.console.debug("Set remote description",o),o&&"slave"===o){var i=I.bind(this,n,a,t);this.createAnswer(i,C,s)}else o&&"master"===o&&e.console.info("handshake finished")},N=function(n,a,t,o){var i=D.bind(this,n,t,a,o,"offer");this.setLocalDescription(new e.RTCSessionDescription(o),i,b)},P=function(n,a,t,o){var i=R.bind(this,n,a,t,"master");this.setRemoteDescription(new e.RTCSessionDescription(o),i,y)},j=function(n,a,t,o){var i=R.bind(this,n,a,t,"slave");this.setRemoteDescription(new e.RTCSessionDescription(o),i,y)},_=function(n,a,t,o){if(a){if(o.candidate)w[a]||(w[a]={}),w[a][t]||(w[a][t]=[]),w[a][t].push(o.candidate),e.console.trace("generating a candidate");else if(w[a]&&w[a][t]&&Array.isArray(w[a][t])){var i=w[a][t];n.sendTo(t,{type:"use-ice-candidates",channel:a,candidates:i.splice(0,i.length)},!0),e.console.trace("From",n.whoAmI(),"to",t,"-> use candidates",i.length)}}else e.console.error("channel invalid or event.candidate null")},x=function(n,a,t,o){if(o&&o.target&&o.target.signalingState)switch(o.target.signalingState){default:e.console.info("signaling state not interesting atm",o.target.signalingState)}else e.console.error("signaling state changed without event value")},L=function(n,a,t,o){if(o&&o.target&&o.target.iceConnectionState)switch(o.target.iceConnectionState){case"connected":case"completed":var i=new e.CustomEvent("signaler:ready",{detail:{channel:a,whoami:t}});e.dispatchEvent(i);break;default:e.console.info("ice state not interesting atm.",o.target.iceConnectionState)}else e.console.error("ice connection state changed without event value")},U=function(n,a){if(a.stream)for(var t,o,i=Object.keys(f[n]),r=0,s=i.length;s>r;r+=1)t=i[r],f[n][t]===this&&(o=new e.CustomEvent("signaler:stream",{detail:{userid:t,stream:a.stream}}),e.dispatchEvent(o));else e.console.error("No stream arrived")},q=function(n,a){if(a.stream)for(var t,o,i=Object.keys(f[n]),r=0,s=i.length;s>r;r+=1)t=i[r],f[n][t]===this&&(o=new e.CustomEvent("signaler:end",{detail:{userid:t}}),e.dispatchEvent(o));else e.console.error("No stream arrived")},Y=function(n,a,t){if(d[a]===n.whoAmI()||i||u[a]&&u[a].indexOf(t)>=0){var o=N.bind(this,n,a,t);this.createOffer(o,g)}else e.console.info("You can not negotiate a p2p connection")},z=function(n,a){var t;i||(t=new e.CustomEvent("signaler:my-stream",{detail:{userid:n.whoAmI(),stream:a}}),i=a,e.dispatchEvent(t))},F=function(n,a,t,o){var i,r,s,d,w,u,v,g,b,y,C,k,A;f[a]||(f[a]={}),m[a]||(m[a]={}),o?(i=new e.RTCPeerConnection(c,h),b=i.createDataChannel("signaler-datachannel",l),y=p.bind(b,a,t),C=E.bind(b,a,t),k=T.bind(b,a,t),A=M.bind(b,a,t),r=_.bind(i,n,a,t),s=U.bind(i,a),d=q.bind(i,a),w=Y.bind(i,n,a,t),u=L.bind(i,n,a,t),v=O.bind(i,a,t),g=x.bind(i,n,a,t),b.onerror=y,b.onmessage=C,b.onopen=k,b.onclose=A,i.onicecandidate=r,i.onaddstream=s,i.onremovestream=d,i.onnegotiationneeded=w,i.oniceconnectionstatechange=u,i.ondatachannel=v,i.onsignalingstatechange=g):(i=new e.RTCPeerConnection(c,h),r=_.bind(i,n,a,t),s=U.bind(i,a),d=q.bind(i,a),w=Y.bind(i,n,a,t),u=L.bind(i,n,a,t),v=O.bind(i,a,t),g=x.bind(i,n,a,t),i.onicecandidate=r,i.onaddstream=s,i.onremovestream=d,i.onnegotiationneeded=w,i.oniceconnectionstatechange=u,i.ondatachannel=v,i.onsignalingstatechange=g),f[a][t]=i},V=function(n,a){a?n.sendTo(v,{type:"create-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},B=function(n,a){a?n.sendTo(v,{type:"join-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},G=function(n){if(n){var a=z.bind(this,n);e.getUserMedia(r,a,A)}else e.console.error("theComunicator is not provided")},H=function(n,a,t){if(a&&i)if(d[a]===n.whoAmI())if(t)f[a][t].addStream(i);else for(var o,r=Object.keys(f[a]),s=0,c=r.length;c>s;s+=1)o=r[s],o&&f[a][o].addStream(i);else f[a][d[a]].addStream(i);else e.console.error(i?"Missing mandatory field <channel>":"You must call Signaler.getUserMedia() before streamOnChannel.")},J=function(n,a,t){n&&a&&m&&m[n]&&m[n][a]?m[n][a].send(t):e.console.error("Missing mandatory fields <channel>, <who> or there is no data-channel for user",a,"in channel",n)},K=function(e,n){if(e&&m&&m[e])for(var a,t,o=Object.keys(m[e]),i=o.length,r=0;i>r;r+=1)a=o[r],a&&(t=m[e][a],t&&t.send(n))},Q=function(n,a,t){a&&t&&d[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"approve",channel:a},!0)):e.console.warn("cause","Please review your code")},W=function(n,a,t){a&&t&&d[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"un-approve",channel:a},!0)):e.console.warn("cause","Please review your code")},X=function(n,a){if(a&&a.detail&&a.detail.what&&a.detail.what.type){var t,o,r,s=a.detail,c=a.detail.what.type;switch(c){case"do-handshake":s.whoami&&s.what.channel?(d[s.what.channel]=s.who,F(n,s.what.channel,s.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"take-offer":s.whoami&&s.what.channel&&s.what.offer?(f[s.what.channel]&&f[s.what.channel][s.whoami]||(F(n,s.what.channel,s.whoami),d[s.what.channel]=s.whoami),j.call(f[s.what.channel][s.whoami],n,s.what.channel,s.whoami,s.what.offer)):e.console.error("Missing mandatory fields: <eventArrived.whoami>, <eventArrived.what.channel> and <eventArrived.what.offer>");break;case"take-answer":P.call(f[s.what.channel][s.whoami],n,s.what.channel,s.whoami,s.what.answer);break;case"take-candidates":if(s.what.candidates)for(t=0,o=S.bind(f[s.what.channel][s.whoami],n,s.what.channel,s.whoami);t<s.what.candidates.length;t+=1)f[s.what.channel][s.whoami].addIceCandidate(new e.RTCIceCandidate(s.what.candidates[t]),o,k);break;case"initiator-quit":Z(n,s.what.channel,!0);break;case"slave-quit":f[s.what.channel]&&f[s.what.channel][s.whoami]&&(f[s.what.channel][s.whoami].close(),delete f[s.what.channel][s.whoami]),m[s.what.channel]&&m[s.what.channel][s.whoami]&&m[s.what.channel][s.whoami].close();break;case"approved":s.whoami&&s.what.channel?(u[s.what.channel]||(u[s.what.channel]=[]),u[s.what.channel].push(s.whoami),F(n,s.what.channel,s.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"un-approved":s.whoami&&s.what.channel?(r=u[s.what.channel].indexOf(s.whoami),r>=0&&(u[s.what.channel].splice(r,1),f[s.what.channel][s.whoami].close(),m[s.what.channel][s.whoami].close(),delete f[s.what.channel][s.whoami],delete m[s.what.channel][s.whoami])):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"you-are-un-approved":s.what.channel&&s.what.users?s.what.users.forEach(function(e){f[s.what.channel]&&f[s.what.channel][e]&&(f[s.what.channel][e].removeStream(i),f[s.what.channel][e].close(),m[s.what.channel][e].close(),delete f[s.what.channel][e],delete m[s.what.channel][e])}):e.console.error("Missing mandatory field: <eventArrived.what.channel> and <eventArrived.what.users>");break;default:e.console.error("Event valid but un-manageable. Target:",a.detail)}}else e.console.error("Event arrived is somehow invalid. Target:",a)},Z=function(n,a,t){if(a)if(f[a]){for(var o,r=f[a],s=Object.keys(r),c=s.length,h=0;c>h;h+=1)o=s[h],f[a]&&f[a][o]&&f[a][o].close(),m[a]&&m[a][o]&&m[a][o].close();!t&&i&&(i.stop(),i=void 0),delete d[a],delete f[a],delete u[a],n.sendTo(v,{type:"leave-channel",channel:a},!0),e.removeEventListener("comunicator:to-me",X,!1)}else e.console.info("No peers in specified channel",a);else e.console.error("Missing mandatory parameter <channel>")},$=function(n,a){var t=V.bind(this,a),o=B.bind(this,a),r=G.bind(this,a),s=H.bind(this,a),c=J.bind(this),h=K.bind(this),l=Q.bind(this,a),d=W.bind(this,a),w=Z.bind(this,a),f=X.bind(this,a),m={userIsPresent:a.userIsPresent,createChannel:t,joinChannel:o,getUserMedia:r,streamOnChannel:s,sendTo:c,broadcast:h,approve:l,unApprove:d,leaveChannel:w};Object.defineProperties(m,{myStream:{get:function(){return i}}}),e.addEventListener("comunicator:to-me",f,!1),n(m)},ee=function(e){o.then($.bind(this,e))};return n&&e.Comunicator?n instanceof e.Promise?o=n:("string"==typeof n||n instanceof String)&&(o=new e.Comunicator(n)):e.console.error("Missing mandatory <url> parameter or Comunicator (http://github.com/720kb/comunicator) not present."),a&&(r=a),t&&(s=t),e._getPeers=function(){return f},e._getDataChannels=function(){return m},e._getIceCandidates=function(){return w},e._getInititators=function(){return d},e._getApprovedUsers=function(){return u},new e.Promise(ee.bind(this))};e.Signaler=n}(window);
//# sourceMappingURL=signaler.min.js.map