/*
 * siglr
 *
 * 
 * https://github.com/720kb/signaler
 * Dario Andrei <wouldgo84@gmail.com>
 * 
 * MIT license
 * 2016-01-28T22:05:21.087Z
 */
!function(e){"use strict";var n=function(n,a,t,o){var i,r,s,c={audio:!0,video:!0},l={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},h={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:23.21.150.121"}]},d={},w={},f={},m={},u={},v={},g={},p="unknown-peer",b=function(n){var a=new e.CustomEvent("signaler:error",{detail:n});e.dispatchEvent(a)},y=function(n){e.console.error(n),b(n)},C=function(n){e.console.error(n),b(n)},k=function(n,a,t){e.console.error(n,a,t),b(t)},A=function(n){e.console.error(n),b(n)},E=function(n){e.console.error(n),b(n)},S=function(n){e.console.error(n),b(n)},T=function(n){e.console.error(n);var a=new e.CustomEvent("signaler:usermedia-error",{detail:n});e.dispatchEvent(a)},M=function(n,a,t){r&&e.console.info("iceCandidate for",t,"in",a,"successfully added")},O=function(n,a,t){if(n&&a&&t&&t.data){if(("string"==typeof t.data||t.data instanceof String)&&t.data.indexOf("_signaler")>=0)switch(t.data){case"_signaler:got-stream?":s&&u[n]&&u[n][a]&&u[n][a].addStream(s);break;default:e.console.error("Not interesting event atm")}else{var o={payload:t.data,whoami:a,channel:n},i=new e.CustomEvent("signaler:data-arrived",{detail:o});e.dispatchEvent(i)}r&&e.console.debug(t.data)}else e.console.error("Missing mandatory fields <channel>, <who> or data channel event not valid")},D=function(n,a){var t={whoami:a,channel:n},o=new e.CustomEvent("signaler:datachannel-opened",{detail:t});v[n][a]=this,g[n]&&g[n].indexOf(a)>=0&&this.send("_signaler:got-stream?"),e.dispatchEvent(o),r&&e.console.info("Data channel",this,"opened...")},I=function(n,a){var t={whoami:a,channel:n},o=new e.CustomEvent("signaler:datachannel-closed",{detail:t});delete v[n][a],0===Object.keys(v[n])&&delete v[n],e.dispatchEvent(o),r&&e.console.info("Data channel",this,"closed.")},R=function(n,a,t){if(n&&a&&t&&t.channel){var o=k.bind(t.channel,n,a),i=O.bind(t.channel,n,a),r=D.bind(t.channel,n,a),s=I.bind(t.channel,n,a);t.channel.onerror=o,t.channel.onmessage=i,t.channel.onopen=r,t.channel.onclose=s}else e.console.error("Missing mandatory fields <channel>, <who> or event not present")},N=function(n,a,t,o,i){if(r&&e.console.debug("Set local description",i),!i||"offer"!==i&&"answer"!==i)e.console.error("Type not recognized:",i);else{var s={type:i,channel:t};s[i]=o,n.sendTo(a,s,!0)}},P=function(n,a,t,o){var i=N.bind(this,n,t,a,o,"answer");this.setLocalDescription(new e.RTCSessionDescription(o),i,C)},j=function(n,a,t,o){if(r&&e.console.debug("Set remote description",o),o&&"slave"===o){var i=P.bind(this,n,a,t);this.createAnswer(i,E,l)}else o&&"master"===o&&r&&e.console.info("handshake finished")},_=function(n,a,t,o){var i=N.bind(this,n,t,a,o,"offer");this.setLocalDescription(new e.RTCSessionDescription(o),i,C)},x=function(n,a,t,o){var i=j.bind(this,n,a,t,"master");this.setRemoteDescription(new e.RTCSessionDescription(o),i,A)},L=function(n,a,t,o){var i=j.bind(this,n,a,t,"slave");this.setRemoteDescription(new e.RTCSessionDescription(o),i,A)},U=function(n,a,t,o){if(a){if(o.candidate)m[a]||(m[a]={}),m[a][t]||(m[a][t]=[]),m[a][t].push(o.candidate),r&&e.console.trace("generating a candidate");else if(m[a]&&m[a][t]&&Array.isArray(m[a][t])){var i=m[a][t];n.sendTo(t,{type:"use-ice-candidates",channel:a,candidates:i.splice(0,i.length)},!0),r&&e.console.trace("From",n.whoAmI(),"to",t,"-> use candidates",i.length)}}else e.console.error("channel invalid or event.candidate null")},q=function(n,a,t,o){if(o&&o.target&&o.target.signalingState)switch(o.target.signalingState){default:r&&e.console.info("signaling state not interesting atm",o.target.signalingState)}else e.console.error("signaling state changed without event value")},Y=function(n,a,t,o){var i;if(o&&o.target&&o.target.iceConnectionState)switch(o.target.iceConnectionState){case"connected":case"completed":i=new e.CustomEvent("signaler:ready",{detail:{channel:a,whoami:t}}),e.dispatchEvent(i);break;default:r&&e.console.info("ice state not interesting atm.",o.target.iceConnectionState)}else e.console.error("ice connection state changed without event value")},z=function(n,a){if(a.stream)for(var t,o,i=Object.keys(u[n]),r=0,s=i.length;s>r;r+=1)t=i[r],u[n][t]===this&&(o=new e.CustomEvent("signaler:stream",{detail:{userid:t,stream:a.stream}}),e.dispatchEvent(o));else e.console.error("No stream arrived")},F=function(n,a){if(a.stream)for(var t,o,i=Object.keys(u[n]),r=0,s=i.length;s>r;r+=1)t=i[r],u[n][t]===this&&(o=new e.CustomEvent("signaler:end",{detail:{userid:t}}),e.dispatchEvent(o));else e.console.error("No stream arrived")},V=function(n,a,t){if(f[a]===n.whoAmI()||s||g[a]&&g[a].indexOf(t)>=0){var o=_.bind(this,n,a,t);this.createOffer(o,y)}else r&&e.console.info("You can not negotiate a p2p connection")},B=function(n,a){var t;s||(t=new e.CustomEvent("signaler:my-stream",{detail:{userid:n.whoAmI(),stream:a}}),s=a,e.dispatchEvent(t))},G=function(n,a,t,o){var i,r,s,c,l,f,m,g,p,b,y,C,A;u[a]||(u[a]={}),v[a]||(v[a]={}),o?(i=new e.RTCPeerConnection(h,d),p=i.createDataChannel("signaler-datachannel",w),b=k.bind(p,a,t),y=O.bind(p,a,t),C=D.bind(p,a,t),A=I.bind(p,a,t),r=U.bind(i,n,a,t),s=z.bind(i,a),c=F.bind(i,a),l=V.bind(i,n,a,t),f=Y.bind(i,n,a,t),m=R.bind(i,a,t),g=q.bind(i,n,a,t),p.onerror=b,p.onmessage=y,p.onopen=C,p.onclose=A,i.onicecandidate=r,i.onaddstream=s,i.onremovestream=c,i.onnegotiationneeded=l,i.oniceconnectionstatechange=f,i.ondatachannel=m,i.onsignalingstatechange=g):(i=new e.RTCPeerConnection(h,d),r=U.bind(i,n,a,t),s=z.bind(i,a),c=F.bind(i,a),l=V.bind(i,n,a,t),f=Y.bind(i,n,a,t),m=R.bind(i,a,t),g=q.bind(i,n,a,t),i.onicecandidate=r,i.onaddstream=s,i.onremovestream=c,i.onnegotiationneeded=l,i.oniceconnectionstatechange=f,i.ondatachannel=m,i.onsignalingstatechange=g),u[a][t]=i},H=function(n,a){a?n.sendTo(p,{type:"create-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},J=function(n,a){a?n.sendTo(p,{type:"join-channel",channel:a},!0):e.console.error("Missing mandatory <channel> parameter.")},K=function(n){if(n){var a=B.bind(this,n);e.getUserMedia(c,a,T)}else e.console.error("theComunicator is not provided")},Q=function(n,a,t){if(a&&s)if(f[a]===n.whoAmI())if(t)u[a][t].addStream(s);else for(var o,i=Object.keys(u[a]),r=0,c=i.length;c>r;r+=1)o=i[r],o&&u[a][o].addStream(s);else u[a][f[a]].addStream(s);else e.console.error(s?"Missing mandatory field <channel>":"You must call Signaler.getUserMedia() before streamOnChannel.")},W=function(n,a,t){n&&a&&v&&v[n]&&v[n][a]?v[n][a].send(t):e.console.error("Missing mandatory fields <channel>, <who> or there is no data-channel for user",a,"in channel",n)},X=function(e,n){if(e&&v&&v[e])for(var a,t,o=Object.keys(v[e]),i=o.length,r=0;i>r;r+=1)a=o[r],a&&(t=v[e][a],t&&t.send(n))},Z=function(n,a,t){a&&t&&f[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"approve",channel:a},!0)):e.console.warn("cause","Please review your code")},$=function(n,a,t){a&&t&&f[a]===n.whoAmI()?(e.isNaN(t)||(t=Number(t)),n.sendTo(t,{type:"un-approve",channel:a},!0)):e.console.warn("cause","Please review your code")},ee=function(n,a){if(a&&a.detail&&a.detail.what&&a.detail.what.type){var t,o,i,r=a.detail,c=a.detail.what.type;switch(c){case"do-handshake":r.whoami&&r.what.channel?(f[r.what.channel]=r.who,G(n,r.what.channel,r.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"take-offer":r.whoami&&r.what.channel&&r.what.offer?(u[r.what.channel]&&u[r.what.channel][r.whoami]||(G(n,r.what.channel,r.whoami),f[r.what.channel]=r.whoami),L.call(u[r.what.channel][r.whoami],n,r.what.channel,r.whoami,r.what.offer)):e.console.error("Missing mandatory fields: <eventArrived.whoami>, <eventArrived.what.channel> and <eventArrived.what.offer>");break;case"take-answer":x.call(u[r.what.channel][r.whoami],n,r.what.channel,r.whoami,r.what.answer);break;case"take-candidates":if(r.what.candidates)for(t=0,o=M.bind(u[r.what.channel][r.whoami],n,r.what.channel,r.whoami);t<r.what.candidates.length;t+=1)u[r.what.channel][r.whoami].addIceCandidate(new e.RTCIceCandidate(r.what.candidates[t]),o,S);break;case"initiator-quit":ne(n,r.what.channel,!0);break;case"slave-quit":u[r.what.channel]&&u[r.what.channel][r.whoami]&&(u[r.what.channel][r.whoami].close(),delete u[r.what.channel][r.whoami]),v[r.what.channel]&&v[r.what.channel][r.whoami]&&v[r.what.channel][r.whoami].close();break;case"approved":r.whoami&&r.what.channel?(g[r.what.channel]||(g[r.what.channel]=[]),g[r.what.channel].push(r.whoami),G(n,r.what.channel,r.whoami,!0)):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"un-approved":r.whoami&&r.what.channel?(i=g[r.what.channel].indexOf(r.whoami),i>=0&&(g[r.what.channel].splice(i,1),u[r.what.channel][r.whoami].close(),v[r.what.channel][r.whoami].close(),delete u[r.what.channel][r.whoami],delete v[r.what.channel][r.whoami])):e.console.error("Missing mandatory fields: <eventArrived.whoami> and <eventArrived.what.channel>");break;case"you-are-un-approved":r.what.channel&&r.what.users?r.what.users.forEach(function(e){u[r.what.channel]&&u[r.what.channel][e]&&(u[r.what.channel][e].removeStream(s),u[r.what.channel][e].close(),v[r.what.channel][e].close(),delete u[r.what.channel][e],delete v[r.what.channel][e])}):e.console.error("Missing mandatory field: <eventArrived.what.channel> and <eventArrived.what.users>");break;default:e.console.error("Event valid but un-manageable. Target:",a.detail)}}else e.console.error("Event arrived is somehow invalid. Target:",a)},ne=function(n,a,t){if(a)if(u[a]){for(var o,i=u[a],c=Object.keys(i),l=c.length,h=0;l>h;h+=1)o=c[h],u[a]&&u[a][o]&&u[a][o].close(),v[a]&&v[a][o]&&v[a][o].close();!t&&s&&(s.stop(),s=void 0),delete f[a],delete u[a],delete g[a],n.sendTo(p,{type:"leave-channel",channel:a},!0),e.removeEventListener("comunicator:to-me",ee,!1)}else r&&e.console.info("No peers in specified channel",a);else e.console.error("Missing mandatory parameter <channel>")},ae=function(n,a){var t=H.bind(this,a),o=J.bind(this,a),i=K.bind(this,a),r=Q.bind(this,a),c=W.bind(this),l=X.bind(this),h=Z.bind(this,a),d=$.bind(this,a),w=ne.bind(this,a),f=ee.bind(this,a),m={userIsPresent:a.userIsPresent,createChannel:t,joinChannel:o,getUserMedia:i,streamOnChannel:r,sendTo:c,broadcast:l,approve:h,unApprove:d,leaveChannel:w};Object.defineProperties(m,{myStream:{get:function(){return s}}}),e.addEventListener("comunicator:to-me",f,!1),n(m)},te=function(e){i.then(ae.bind(this,e))};return n&&e.Comunicator?n instanceof e.Promise?i=n:("string"==typeof n||n instanceof String)&&(i=new e.Comunicator(n)):e.console.error("Missing mandatory <url> parameter or Comunicator (http://github.com/720kb/comunicator) not present."),a&&(c=a),t&&(l=t),r=o?o:!1,e._getPeers=function(){return u},e._getDataChannels=function(){return v},e._getIceCandidates=function(){return m},e._getInititators=function(){return f},e._getApprovedUsers=function(){return g},new e.Promise(te.bind(this))};e.Signaler=n}(window);
//# sourceMappingURL=signaler.min.js.map